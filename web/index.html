<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Mzansi Marketplace - Your local food and goods marketplace">

  <!-- Mobile Viewport Optimizations -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Mzansi Marketplace">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <meta name="msapplication-tap-highlight" content="no">
  
  <!-- iOS Icons -->
  <link rel="apple-touch-icon" href="icons/Icon-192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icons/Icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/Icon-192.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>Mzansi Marketplace</title>
  <link rel="manifest" href="manifest.json">
  
  <!-- Flutter Web Configuration - HTML Renderer for better stability -->
  <script>
    // Safari-specific fixes
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    
    if (isSafari || isIOS) {
      console.log('üîç Safari/iOS detected - applying specific fixes');
      
      // Fix deprecated Intl.v8BreakIterator issue for Safari
      if (typeof Intl !== 'undefined') {
        try {
          // Safari-specific Intl polyfill
          if (Intl.v8BreakIterator && !Intl.Segmenter) {
            Intl.Segmenter = Intl.v8BreakIterator;
            console.log('‚úÖ Intl polyfill applied for Safari');
          }
          
          // Suppress all deprecation warnings in Safari
          const originalConsoleWarn = console.warn;
          console.warn = function(...args) {
            const message = args[0]?.toString() || '';
            if (message.includes('Intl.v8BreakIterator') || 
                message.includes('deprecated') ||
                message.includes('Deprecation')) {
              return; // Suppress deprecation warnings in Safari
            }
            originalConsoleWarn.apply(console, args);
          };
        } catch (e) {
          console.log('‚ö†Ô∏è Intl polyfill failed:', e);
        }
      }
      
      // Enhanced Safari memory management for iOS
      if (isIOS) {
        console.log('üì± iOS Safari detected - applying memory optimizations');
        
        // Prevent page reload on visibility change
        let isPageVisible = true;
        
        window.addEventListener('pagehide', function(e) {
          console.log('üì± Page hiding - iOS Safari memory management');
          isPageVisible = false;
          
          // Try to prevent the page from being discarded
          if (e.persisted) {
            console.log('üì± Page will be cached');
          } else {
            console.log('üì± Page might be discarded');
          }
        });
        
        window.addEventListener('pageshow', function(e) {
          console.log('üì± Page showing - iOS Safari restored');
          isPageVisible = true;
          
          if (e.persisted) {
            console.log('üì± Page restored from cache');
          } else {
            console.log('üì± Page reloaded from scratch');
          }
        });
        
        // Prevent reload on focus/blur
        window.addEventListener('blur', function() {
          console.log('üì± Window blurred - maintaining state');
        });
        
        window.addEventListener('focus', function() {
          console.log('üì± Window focused - checking state');
          if (!isPageVisible) {
            console.log('üì± Preventing unnecessary reload');
          }
        });
        
        // Enhanced memory management
        window.addEventListener('visibilitychange', function() {
          if (document.hidden) {
            console.log('üì± Page hidden - pausing animations');
            // Flutter will handle this automatically with CanvasKit
          } else {
            console.log('üì± Page visible - resuming');
          }
        });
        
        // Prevent iOS Safari from reloading on low memory
        window.addEventListener('beforeunload', function(e) {
          console.log('üì± Before unload - saving state');
          // Don't show confirmation dialog but prepare for potential reload
        });
      }
    } else {
      // Non-Safari browsers - minimal fixes
      if (typeof Intl !== 'undefined' && Intl.v8BreakIterator) {
        if (!Intl.Segmenter) {
          Intl.Segmenter = Intl.v8BreakIterator;
        }
      }
    }
    
    // Set Flutter configuration for better compatibility
    window.flutterConfiguration = {
      renderer: "canvaskit"
    };
    
    // Initialize Flutter object structure
    window._flutter = {
      buildConfig: {
        renderer: "canvaskit",
        canvasKitBaseUrl: "/canvaskit/"
      }
    };
    
    // Ensure Flutter configuration is available globally
    if (typeof window.flutterConfiguration === 'undefined') {
      window.flutterConfiguration = { renderer: "canvaskit" };
    }
    
    // Log configuration for debugging
    console.log('Flutter Configuration:', window.flutterConfiguration);
    console.log('Flutter Build Config:', window._flutter.buildConfig);
    console.log('Browser:', isSafari ? 'Safari' : 'Other', isIOS ? 'iOS' : 'Desktop');
  </script>
  
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/flutter_service_worker.js');
      });
    }
  </script>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://ik.imagekit.io" crossorigin>
  <meta name="theme-color" content="#1F4654" />
  <link rel="canonical" href="https://marketplace-8d6bd.web.app/" />
  <meta property="og:site_name" content="Mzansi Marketplace" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Mzansi Marketplace" />
  <meta property="og:description" content="Your local SA marketplace for food and goods" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Mzansi Marketplace" />
  <meta name="twitter:description" content="Your local SA marketplace for food and goods" />
  
  <!-- Mobile Keyboard and Viewport Fixes -->
  <style>
    /* Base mobile optimizations */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow-x: hidden;
      position: relative;
    }
    
    /* Prevent iOS Safari overscroll/bounce effects */
    html {
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
    }
    
    body {
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
    }
    
    /* Prevent text selection on mobile */
    * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* Allow text selection in input fields */
    input, textarea {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    
    /* Prevent zoom on input focus */
    input[type="text"], input[type="email"], input[type="password"], textarea {
      font-size: 16px;
    }
    
    /* Flutter canvas optimization */
    #flutter_target {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }
    
    /* Prefer dynamic viewport units when supported to reduce iOS top-bar jump */
    @supports (height: 100dvh) {
      html, body, #flutter_target {
        height: 100dvh;
        min-height: 100dvh;
      }
    }
    
    /* Mobile viewport handling */
    @media screen and (max-width: 768px) {
      html, body {
        height: 100vh;
        height: -webkit-fill-available;
        height: -moz-available;
        height: stretch;
        position: relative;
        overflow: auto;
      }
      
      #flutter_target {
        height: 100vh;
        height: -webkit-fill-available;
        height: -moz-available;
        height: stretch;
        min-height: 100vh;
        min-height: -webkit-fill-available;
        min-height: -moz-available;
        min-height: stretch;
      }
    }
    
    /* Handle mobile keyboard */
    @media screen and (max-height: 600px) {
      /* When keyboard is visible */
      html, body {
        height: 100vh;
        height: -webkit-fill-available;
        height: -moz-available;
        height: stretch;
        position: relative;
        overflow: auto;
      }
      
      #flutter_target {
        height: 100vh;
        height: -webkit-fill-available;
        height: -moz-available;
        height: stretch;
        min-height: 100vh;
        min-height: -webkit-fill-available;
        min-height: -moz-available;
        min-height: stretch;
      }
    }
    
    /* Portrait orientation */
    @media screen and (max-width: 768px) and (orientation: portrait) {
      html, body {
        height: 100vh;
        height: -webkit-fill-available;
        height: -moz-available;
        height: stretch;
        position: relative;
        overflow: auto;
      }
    }
    
    /* Landscape orientation */
    @media screen and (max-width: 768px) and (orientation: landscape) {
      html, body {
        height: 100vh;
        height: -webkit-fill-available;
        height: -moz-available;
        height: stretch;
        position: relative;
        overflow: auto;
      }
    }
    
    /* Android Chrome specific fixes */
    @media screen and (max-width: 768px) {
      /* Prevent Android Chrome from resizing viewport */
      html {
        height: 100vh;
        height: -webkit-fill-available;
        height: -moz-available;
        height: stretch;
      }
      
      body {
        height: 100vh;
        height: -webkit-fill-available;
        height: -moz-available;
        height: stretch;
        min-height: 100vh;
        min-height: -webkit-fill-available;
        min-height: -moz-available;
        min-height: stretch;
      }
    }
    
    /* iOS Safari specific fixes - Enhanced for stability */
    @supports (-webkit-touch-callout: none) {
      html, body {
        height: 100vh;
        height: -webkit-fill-available;
        /* Prevent page refresh on memory pressure */
        -webkit-transform: translateZ(0);
        -webkit-backface-visibility: hidden;
        will-change: auto;
      }
      
      #flutter_target {
        height: 100vh;
        height: -webkit-fill-available;
        min-height: 100vh;
        min-height: -webkit-fill-available;
        /* GPU acceleration for better performance */
        -webkit-transform: translateZ(0);
        -webkit-backface-visibility: hidden;
        transform: translateZ(0);
        backface-visibility: hidden;
      }
      
      /* Reduce memory pressure with CSS containment */
      * {
        contain: layout style paint;
      }
      
      /* Optimize images and media for memory */
      img, video, canvas {
        -webkit-transform: translateZ(0);
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
      }
    }
  </style>
  
  <!-- Mobile Keyboard Management Script -->
  <script>
    // Handle mobile keyboard and viewport issues
    function handleMobileViewport() {
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      if (isMobile) {
        // Set viewport height for mobile
        let resizeTimer;
        const setViewportHeight = () => {
          const vh = window.innerHeight * 0.01;
          document.documentElement.style.setProperty('--vh', `${vh}px`);
          
          // Update body height
          document.body.style.height = `${window.innerHeight}px`;
          document.body.style.minHeight = `${window.innerHeight}px`;
        };
        
        // Set initial height
        setViewportHeight();
        
        // Update on resize (keyboard show/hide)
        const debouncedResize = () => {
          if (resizeTimer) cancelAnimationFrame(resizeTimer);
          resizeTimer = requestAnimationFrame(setViewportHeight);
        };
        window.addEventListener('resize', debouncedResize);
        window.addEventListener('orientationchange', debouncedResize);
        
        // Handle visual viewport changes
        if (window.visualViewport) {
          window.visualViewport.addEventListener('resize', debouncedResize);
        }
      }
    }
    
    // Reduce scroll position restores that can cause jumps on Safari
    try { if ('scrollRestoration' in history) { history.scrollRestoration = 'manual'; } } catch (_) {}

    // iOS Safari: prevent pull-to-refresh/bounce which looks like a page refresh
    (function() {
      const ua = navigator.userAgent || '';
      const isSafari = ua.includes('Safari') && !ua.includes('Chrome');
      const isIOS = /iP(ad|hone|od)/.test(ua);
      if (!(isSafari && isIOS)) return;

      let startY = 0;
      let startX = 0;
      let active = false;

      const onTouchStart = (e) => {
        if (!e.touches || e.touches.length !== 1) return;
        startY = e.touches[0].clientY;
        startX = e.touches[0].clientX;
        active = true;
      };

      const onTouchMove = (e) => {
        if (!active || !e.touches || e.touches.length !== 1) return;
        const currentY = e.touches[0].clientY;
        const deltaY = currentY - startY;
        const el = document.scrollingElement || document.documentElement;
        const atTop = el.scrollTop <= 0;
        const atBottom = Math.ceil(el.scrollTop + el.clientHeight) >= el.scrollHeight;
        const movingDown = deltaY > 0;
        const movingUp = deltaY < 0;

        // Prevent overscroll at the top (pull-to-refresh) or bottom bounce
        if ((atTop && movingDown) || (atBottom && movingUp)) {
          e.preventDefault();
        }
      };

      const onTouchEnd = () => { active = false; };

      document.addEventListener('touchstart', onTouchStart, { passive: false });
      document.addEventListener('touchmove', onTouchMove, { passive: false });
      document.addEventListener('touchend', onTouchEnd, { passive: true });
    })();
    
    // Enhanced Safari page preservation
    window.addEventListener('pagehide', function(e) {
      if (e.persisted) {
        console.log('üì± Page is being cached by Safari');
      } else {
        console.log('üì± Page might be discarded - preparing state');
        // Save critical state to localStorage if needed
        try {
          localStorage.setItem('flutter_app_state', JSON.stringify({
            timestamp: Date.now(),
            url: window.location.href
          }));
        } catch (e) {
          console.log('Could not save state:', e);
        }
      }
    });
    
    // Prevent Safari from reloading on focus
    window.addEventListener('focus', function(e) {
      console.log('üì± Window focused - maintaining state');
    });
    
    // iOS Safari specific: Prevent reload on tab switch
    if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
      // Keep connection alive
      setInterval(function() {
        // Minimal activity to prevent iOS from killing the page
        if (!document.hidden) {
          // Just log to keep JavaScript engine active
          console.debug('üì± Keeping iOS Safari active');
        }
      }, 30000); // Every 30 seconds when visible
      
      // Prevent iOS Safari auto-refresh on return
      window.addEventListener('pageshow', function(e) {
        if (e.persisted) {
          console.log('üì± Page restored from iOS cache');
        } else {
          console.log('üì± Page reloaded - checking for saved state');
          try {
            const savedState = localStorage.getItem('flutter_app_state');
            if (savedState) {
              const state = JSON.parse(savedState);
              console.log('üì± Found saved state from:', new Date(state.timestamp));
            }
          } catch (e) {
            console.log('üì± No previous state found');
          }
        }
      });
    }
    
    // Initialize mobile optimizations
    document.addEventListener('DOMContentLoaded', function() {
      handleMobileViewport();
      
      // Safari-specific optimizations
      if (navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome')) {
        // Prevent zoom on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
          const now = (new Date()).getTime();
          if (now - lastTouchEnd <= 300) {
            event.preventDefault();
          }
          lastTouchEnd = now;
        }, false);
        
        // Prevent pull-to-refresh
        // Handled globally above; keep this minimal to avoid double prevention
      }
    });
  </script>
</head>
<body>
  <!-- Flutter Web App Container -->
  <div id="flutter_target"></div>
  
  <!-- Enhanced Flutter Web Scripts -->
  <script src="flutter_init.js"></script>
  <script src="flutter.js" defer></script>
  <script>
    window.addEventListener('load', function(ev) {
      // Use the standard Flutter web initialization pattern
      console.log('Starting Flutter initialization...');
      
      // Enhanced Flutter initialization with better error handling
      const initFlutter = () => {
        try {
          // Use the configuration we set up
          const config = window.flutterConfiguration || { renderer: "canvaskit" };
          console.log('üöÄ Initializing Flutter with config:', config);
          
          // Check if Flutter is available
          if (window._flutter_loader || window.flutter?.loader) {
            const loader = window._flutter_loader || window.flutter.loader;
            console.log('üì± Using Flutter loader...');
            
            loader.load({
              serviceWorkerSettings: {
                serviceWorkerVersion: '1.0.0',
              },
              config: config,
              onEntrypointLoaded: function(engineInitializer) {
                console.log('üéØ Flutter entrypoint loaded');
                engineInitializer.initializeEngine(config).then(function(appRunner) {
                  console.log('‚úÖ Flutter engine initialized');
                  appRunner.runApp();
                  
                  // Dispatch custom event for iOS optimizations
                  document.dispatchEvent(new CustomEvent('flutter-initialized'));
                }).catch(function(error) {
                  console.error('‚ùå Flutter engine initialization failed:', error);
                  fallbackInit();
                });
              }
            });
          } else if (window.flutter) {
            console.log('üì± Using legacy flutter loader...');
            window.flutter.loader.loadEntrypoint({
              serviceWorker: {
                serviceWorkerVersion: '1.0.0',
              },
              config: config,
              onEntrypointLoaded: function(engineInitializer) {
                engineInitializer.initializeEngine(config).then(function(appRunner) {
                  appRunner.runApp();
                  document.dispatchEvent(new CustomEvent('flutter-initialized'));
                });
              }
            });
          } else {
            console.log('‚ö†Ô∏è Flutter loader not found, using fallback...');
            fallbackInit();
          }
        } catch (error) {
          console.error('‚ùå Flutter initialization error:', error);
          fallbackInit();
        }
      };
      
      // Fallback initialization for older Flutter versions
      const fallbackInit = () => {
        console.log('üîÑ Attempting fallback initialization...');
        const script = document.createElement('script');
        script.src = 'main.dart.js';
        script.type = 'application/javascript';
        script.onload = function() {
          console.log('‚úÖ Fallback: main.dart.js loaded');
          document.dispatchEvent(new CustomEvent('flutter-initialized'));
        };
        script.onerror = function() {
          console.error('‚ùå Fallback: Failed to load main.dart.js');
        };
        document.head.appendChild(script);
      };
      
      // Wait a bit for flutter.js to initialize
      setTimeout(initFlutter, 100);
    });
  </script>
</body>
</html>
