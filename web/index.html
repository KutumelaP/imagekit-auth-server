<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Mzansi Marketplace - Your local food and goods marketplace">
  <!-- Explicit mobile viewport to prevent desktop-scale rendering in iOS PWA/Safari -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">

  <!-- Mobile Viewport Optimizations - Flutter Web will add its own viewport tag -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Mzansi Marketplace">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <meta name="msapplication-tap-highlight" content="no">
  
  <!-- iOS Icons -->
  <link rel="apple-touch-icon" href="icons/Icon-192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icons/Icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/Icon-192.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>Mzansi Marketplace</title>
  <link rel="manifest" href="manifest.json">
  
  <!-- iOS PWA-only gate: detect iOS Safari tab (not standalone) and block app, show install overlay -->
  <style>
    :root {
      --brand-bg: #1F4654; /* from manifest theme_color */
      --brand-bg-grad: linear-gradient(180deg, rgba(31,70,84,1) 0%, rgba(16,38,45,1) 100%);
      --brand-card: rgba(255,255,255,0.06);
      --brand-text: #ffffff;
      --brand-subtle: #cbd5e1;
      --brand-accent: #22c55e;
    }
    #ios-pwa-gate { display:none; position:fixed; inset:0; z-index:2147483647; background: rgba(31,70,84,0.95); color: var(--brand-text); backdrop-filter: blur(8px); }
    #ios-pwa-gate .wrap { max-width:560px; margin:0 auto; padding:32px 20px; }
    #ios-pwa-gate .card { background: var(--brand-card); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(8px); border-radius: 12px; padding: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.25); }
    #ios-pwa-gate .logo { display:flex; align-items:center; gap:12px; margin-bottom: 12px; }
    #ios-pwa-gate .logo img { width: 40px; height: 40px; border-radius: 8px; }
    #ios-pwa-gate h1 { font-size:20px; margin:0 0 8px; }
    #ios-pwa-gate p { line-height:1.5; color: var(--brand-subtle); margin: 0 0 8px; }
    #ios-pwa-gate .steps { margin-top:10px; padding-left: 18px; }
    #ios-pwa-gate .steps li { margin:8px 0; }
    #ios-pwa-gate .btn-row { display:flex; gap:10px; margin-top:16px; }
    #ios-pwa-gate .btn { background: var(--brand-accent); color:#0f172a; border:0; border-radius:8px; padding:10px 14px; font-weight:700; cursor:pointer; }
    #ios-pwa-gate .link { background: transparent; color: var(--brand-subtle); border:1px solid rgba(255,255,255,0.2); border-radius:8px; padding:10px 14px; font-weight:600; cursor:pointer; }

    /* Android APK banner */
    #android-apk-banner { display:none; position: fixed; left: 0; right: 0; bottom: 12px; z-index: 2147483600; }
    #android-apk-banner .inner { margin: 0 auto; max-width: 640px; background: #0b1320; color: #fff; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 14px 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); display: flex; align-items: center; gap: 12px; }
    #android-apk-banner img { width: 32px; height: 32px; border-radius: 6px; }
    #android-apk-banner .title { font-weight: 700; }
    #android-apk-banner .cta { margin-left: auto; background: var(--brand-accent); color: #0f172a; border: 0; border-radius: 8px; padding: 8px 12px; font-weight: 700; cursor: pointer; }
    #android-apk-banner .dismiss { background: transparent; border: 0; color: #9fb0c3; margin-left: 8px; cursor: pointer; }

    /* Boot fallback overlay */
    #boot-fallback { display:none; position: fixed; inset: 0; z-index: 2147483646; background: rgba(15,23,42,0.98); color: #fff; }
    #boot-fallback .wrap { max-width: 560px; margin: 0 auto; padding: 32px 20px; }
    #boot-fallback .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 20px; }
    #boot-fallback h2 { margin: 0 0 8px; font-size: 18px; }
    #boot-fallback p { margin: 0 0 8px; color: #cbd5e1; }
    #boot-fallback .btn-row { display:flex; gap:10px; margin-top:14px; flex-wrap: wrap; }
    #boot-fallback .btn { background: var(--brand-accent); color:#0f172a; border:0; border-radius:8px; padding:10px 14px; font-weight:700; cursor:pointer; }
    #boot-fallback .link { background: transparent; color: var(--brand-subtle); border:1px solid rgba(255,255,255,0.2); border-radius:8px; padding:10px 14px; font-weight:600; cursor:pointer; }
  </style>
  <script>
    (function(){
      // ‚ö° FAST LOAD: Optimized detection with minimal blocking
      var userAgent = navigator.userAgent || '';
      var isIOS = /iPad|iPhone|iPod/.test(userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      var isStandalone = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || window.navigator.standalone === true;
      
      // Quick checks for faster loading
      var pwaGateDismissed = localStorage.getItem('pwa_gate_dismissed') === '1';
      var isDirectStoreUrl = window.location.pathname.includes('/store/') || window.location.pathname.includes('/seller/');
      var skipParam = new URLSearchParams(window.location.search).get('skip_gate') === '1';
      var forceShow = urlParams.get('show_gate') === '1'; // Debug parameter
      
      // üîç DEBUG: Log all conditions
      console.log('üîç PWA Gate Debug Info:');
      console.log('  - User Agent:', userAgent);
      console.log('  - Platform:', platform);
      console.log('  - isIOS:', isIOS);
      console.log('  - isStandalone:', isStandalone);
      console.log('  - pwaGateDismissed:', pwaGateDismissed);
      console.log('  - isDirectStoreUrl:', isDirectStoreUrl);
      console.log('  - skipParam:', skipParam);
      console.log('  - forceShow:', forceShow);
      console.log('  - Current URL:', window.location.href);
      
      // Enhanced condition logic
      var shouldShowGate = false;
      
      if (forceShow) {
        console.log('üöÄ Force showing PWA gate via ?show_gate=1');
        shouldShowGate = true;
      } else if (isIOS && !isStandalone) {
        if (!pwaGateDismissed && !skipParam) {
          // Always show for iOS Safari unless explicitly dismissed or skipped
          shouldShowGate = true;
          console.log('‚úÖ PWA gate will show for iOS Safari user');
        } else {
          console.log('‚ùå PWA gate blocked - dismissed or skipped');
        }
      } else if (isIOS && isStandalone) {
        console.log('‚úÖ User already has PWA installed');
      } else {
        console.log('‚ÑπÔ∏è Not iOS or detection failed');
      }
      
      if (shouldShowGate) {
        console.log('üéØ Preparing to show PWA gate...');
        
        function showPWAGate() {
          var gate = document.getElementById('ios-pwa-gate');
          console.log('üîç Gate element found:', !!gate);
          
          if (gate) {
            // Customize message for store URLs
            if (isDirectStoreUrl) {
              var title = gate.querySelector('#pwa-title');
              var description = gate.querySelector('#pwa-description');
              if (title) title.textContent = 'Install App to Access This Store';
              if (description) description.textContent = 'This store link works best in the installed app. Safari has performance issues with marketplace features.';
              console.log('üìù Customized message for store URL');
            }
            
            // Show the gate
            gate.style.display = 'block';
            gate.style.pointerEvents = 'none';
            
            var card = gate.querySelector('.card');
            if (card) {
              card.style.pointerEvents = 'all';
            }
            
            console.log('‚úÖ PWA gate displayed successfully!');
            
            // Add a bright highlight for debugging
            if (forceShow) {
              gate.style.border = '3px solid red';
              gate.style.boxShadow = '0 0 20px rgba(255,0,0,0.5)';
            }
          } else {
            console.error('‚ùå PWA gate element not found!');
          }
        }
        
        // Try multiple times to ensure the element exists
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', showPWAGate);
        } else {
          showPWAGate();
        }
        
        // Backup: Try again after 500ms
        setTimeout(showPWAGate, 500);
        
        // Backup: Try again after 2 seconds  
        setTimeout(showPWAGate, 2000);
      } else {
        console.log('‚ùå PWA gate will not show - conditions not met');
      }
    })();
  </script>

  <!-- Global boot error logging and Android APK banner logic -->
  <script>
    (function(){
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      const isAndroid = /Android/i.test(ua);
      const isStandalone = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || window.navigator.standalone === true;

      // Robust boot logging
      window.addEventListener('error', function(e){
        try { console.error('[BootError]', e.message || e.error, e.filename, e.lineno, e.colno, e.error); } catch(_) {}
      });
      window.addEventListener('unhandledrejection', function(e){
        try { console.error('[UnhandledRejection]', e.reason || e); } catch(_) {}
      });

      // Android APK banner
      document.addEventListener('DOMContentLoaded', function(){
        const banner = document.getElementById('android-apk-banner');
        const btn = document.getElementById('apk-download-btn');
        const dismiss = document.getElementById('apk-dismiss-btn');
        const dismissed = localStorage.getItem('apk_banner_dismissed_v1') === '1';
        const APK_DOWNLOAD_URL = window.APK_DOWNLOAD_URL || '/app.apk'; // TODO: replace with your real APK URL

        if (isAndroid && !isStandalone && !dismissed) {
          if (banner) banner.style.display = 'block';
          if (btn) btn.addEventListener('click', function(){
            try { localStorage.setItem('apk_banner_dismissed_v1', '1'); } catch(_) {}
            window.location.href = APK_DOWNLOAD_URL;
          });
          if (dismiss) dismiss.addEventListener('click', function(){
            try { localStorage.setItem('apk_banner_dismissed_v1', '1'); } catch(_) {}
            if (banner) banner.style.display = 'none';
          });
        }
      });
    })();
  </script>

  <!-- Flutter Web Configuration - HTML Renderer for better stability -->
  <script>
    // Safari-specific fixes
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
    const isIOS = /iP(ad|hone|od)/.test(ua);
    const isAndroid = /Android/i.test(ua);
    
    if (isSafari || isIOS) {
      console.log('üîç Safari/iOS detected - applying specific fixes');
      
      // Fix deprecated Intl.v8BreakIterator issue for Safari
      if (typeof Intl !== 'undefined') {
        try {
          // Safari-specific Intl polyfill
          if (Intl.v8BreakIterator && !Intl.Segmenter) {
            Intl.Segmenter = Intl.v8BreakIterator;
            console.log('‚úÖ Intl polyfill applied for Safari');
          }
          
          // Suppress all deprecation warnings in Safari
          const originalConsoleWarn = console.warn;
          console.warn = function(...args) {
            const message = args[0]?.toString() || '';
            if (message.includes('Intl.v8BreakIterator') || 
                message.includes('deprecated') ||
                message.includes('Deprecation')) {
              return; // Suppress deprecation warnings in Safari
            }
            originalConsoleWarn.apply(console, args);
          };
        } catch (e) {
          console.log('‚ö†Ô∏è Intl polyfill failed:', e);
        }
      }
      
      // Enhanced Safari memory management for iOS
      if (isIOS) {
        console.log('üì± iOS Safari detected - applying memory optimizations');
        
        // Prevent page reload on visibility change
        let isPageVisible = true;
        
        window.addEventListener('pagehide', function(e) {
          console.log('üì± Page hiding - iOS Safari memory management');
          isPageVisible = false;
          
          // Try to prevent the page from being discarded
          if (e.persisted) {
            console.log('üì± Page will be cached');
          } else {
            console.log('üì± Page might be discarded');
          }
        });
        
        window.addEventListener('pageshow', function(e) {
          console.log('üì± Page showing - iOS Safari restored');
          isPageVisible = true;
          
          if (e.persisted) {
            console.log('üì± Page restored from cache');
          } else {
            console.log('üì± Page reloaded from scratch');
          }
        });
        
        // Prevent reload on focus/blur
        window.addEventListener('blur', function() {
          console.log('üì± Window blurred - maintaining state');
        });
        
        window.addEventListener('focus', function() {
          console.log('üì± Window focused - checking state');
          if (!isPageVisible) {
            console.log('üì± Preventing unnecessary reload');
          }
        });
        
        // Enhanced memory management
        window.addEventListener('visibilitychange', function() {
          if (document.hidden) {
            console.log('üì± Page hidden - pausing animations');
            // Flutter will handle this automatically with CanvasKit
          } else {
            console.log('üì± Page visible - resuming');
          }
        });
        
        // Prevent iOS Safari from reloading on low memory
        window.addEventListener('beforeunload', function(e) {
          console.log('üì± Before unload - saving state');
          // Don't show confirmation dialog but prepare for potential reload
        });
      }
    } else {
      // Non-Safari browsers - minimal fixes
      if (typeof Intl !== 'undefined' && Intl.v8BreakIterator) {
        if (!Intl.Segmenter) {
          Intl.Segmenter = Intl.v8BreakIterator;
        }
      }
    }
    
    // Set Flutter configuration for better compatibility
    // Renderer selection with override and default
    const urlRenderer = (new URLSearchParams(location.search)).get('r');
    if (urlRenderer === 'html' || urlRenderer === 'canvaskit') {
      try { localStorage.setItem('web_renderer_override', urlRenderer); } catch(_) {}
    }
    let overrideRenderer = (() => { try { return localStorage.getItem('web_renderer_override'); } catch(_) { return null; } })();
    // Prefer HTML renderer on iOS Safari tabs to avoid white-screen issues
    const defaultRenderer = isIOS ? 'html' : 'canvaskit';
    // Do not force HTML renderer; rely on Flutter default/CanvasKit.
    // For iOS/Safari, use default CanvasKit (no chromium variant).
    const chosenRenderer = (overrideRenderer === 'html' || overrideRenderer === 'canvaskit') ? overrideRenderer : defaultRenderer;
    window.flutterConfiguration = { renderer: chosenRenderer };
    
    // Ensure Flutter configuration is available globally
    if (typeof window.flutterConfiguration === 'undefined') {
      window.flutterConfiguration = { renderer: isIOS ? "html" : "canvaskit" };
    }
    
    // Log configuration for debugging
    console.log('Flutter Configuration:', window.flutterConfiguration, '(override:', overrideRenderer || 'none', ')');
    console.log('Browser:', isSafari ? 'Safari' : 'Other', isIOS ? 'iOS' : (isAndroid ? 'Android' : 'Desktop'));
  </script>
  
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        if (!window.__blockFlutter) {
          // Register Flutter service worker
          navigator.serviceWorker.register('/flutter_service_worker.js')
            .then(function(registration) {
              console.log('Flutter service worker registered successfully:', registration);
            })
            .catch(function(error) {
              console.error('Flutter service worker registration failed:', error);
            });
          
          // Register Firebase messaging service worker
          navigator.serviceWorker.register('/firebase-messaging-sw.js', {
            scope: '/firebase-cloud-messaging-push-scope'
          })
          .then(function(registration) {
            console.log('FCM service worker registered successfully:', registration);
          })
          .catch(function(error) {
            console.error('FCM service worker registration failed:', error);
          });
        }
      });
    }
  </script>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://ik.imagekit.io" crossorigin>
  <meta name="theme-color" content="#1F4654" />
  <link rel="canonical" href="https://marketplace-8d6bd.web.app/" />
  <meta property="og:site_name" content="Mzansi Marketplace" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Mzansi Marketplace" />
  <meta property="og:description" content="Your local SA marketplace for food and goods" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Mzansi Marketplace" />
  <meta name="twitter:description" content="Your local SA marketplace for food and goods" />
  
  <!-- Mobile Keyboard and Viewport Fixes -->
  <style>
    /* Base mobile optimizations */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow-x: hidden;
      position: relative;
    }
    
    /* Prevent iOS Safari overscroll/bounce effects */
    html {
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
    }
    
    body {
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
    }
    
    /* Prevent text selection on mobile */
    * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* Allow text selection in input fields */
    input, textarea {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    
    /* Prevent zoom on input focus */
    input[type="text"], input[type="email"], input[type="password"], textarea {
      font-size: 16px;
    }
    
    /* Flutter canvas optimization */
    #flutter_target {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }
    
    /* Prefer dynamic viewport units when supported to reduce iOS top-bar jump */
    @supports (height: 100dvh) {
      html, body, #flutter_target {
        height: 100dvh;
        min-height: 100dvh;
      }
    }
    
    /* Mobile viewport handling */
    @media screen and (max-width: 768px) {
      html, body {
        height: 100vh;
        height: -webkit-fill-available;
        height: -moz-available;
        height: stretch;
        position: relative;
        overflow: auto;
      }
      
      #flutter_target {
        height: 100vh;
        height: -webkit-fill-available;
        height: -moz-available;
        height: stretch;
        min-height: 100vh;
        min-height: -webkit-fill-available;
        min-height: -moz-available;
        min-height: stretch;
      }
    }
    
    /* Handle mobile keyboard */
    @media screen and (max-height: 600px) {
      /* When keyboard is visible */
      html, body {
        height: 100vh;
        height: -webkit-fill-available;
        height: -moz-available;
        height: stretch;
        position: relative;
        overflow: auto;
      }
      
      #flutter_target {
        height: 100vh;
        height: -webkit-fill-available;
        height: -moz-available;
        height: stretch;
        min-height: 100vh;
        min-height: -webkit-fill-available;
        min-height: -moz-available;
        min-height: stretch;
      }
    }
    
    /* Portrait orientation */
    @media screen and (max-width: 768px) and (orientation: portrait) {
      html, body {
        height: 100vh;
        height: -webkit-fill-available;
        height: -moz-available;
        height: stretch;
        position: relative;
        overflow: auto;
      }
    }
    
    /* Landscape orientation */
    @media screen and (max-width: 768px) and (orientation: landscape) {
      html, body {
        height: 100vh;
        height: -webkit-fill-available;
        height: -moz-available;
        height: stretch;
        position: relative;
        overflow: auto;
      }
    }
    
    /* Android Chrome specific fixes */
    @media screen and (max-width: 768px) {
      /* Prevent Android Chrome from resizing viewport */
      html {
        height: 100vh;
        height: -webkit-fill-available;
        height: -moz-available;
        height: stretch;
      }
      
      body {
        height: 100vh;
        height: -webkit-fill-available;
        height: -moz-available;
        height: stretch;
        min-height: 100vh;
        min-height: -webkit-fill-available;
        min-height: -moz-available;
        min-height: stretch;
      }
    }
    
    /* iOS Safari specific fixes - Enhanced for stability */
    @supports (-webkit-touch-callout: none) {
      html, body {
        height: 100vh;
        height: -webkit-fill-available;
        /* Prevent page refresh on memory pressure */
        -webkit-transform: translateZ(0);
        -webkit-backface-visibility: hidden;
        will-change: auto;
      }
      
      #flutter_target {
        height: 100vh;
        height: -webkit-fill-available;
        min-height: 100vh;
        min-height: -webkit-fill-available;
        /* GPU acceleration for better performance */
        transform: translateZ(0);
        backface-visibility: hidden;
        -webkit-transform: translateZ(0);
        -webkit-backface-visibility: hidden;
      }
      
      /* Reduce memory pressure with CSS containment */
      * {
        contain: layout style paint;
      }
      
      /* Optimize images and media for memory */
      img, video, canvas {
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
      }
    }
  </style>
  
  <!-- Mobile Keyboard Management Script -->
  <script>
    // Handle mobile keyboard and viewport issues
    function handleMobileViewport() {
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      if (isMobile) {
        // Set viewport height for mobile
        let resizeTimer;
        const setViewportHeight = () => {
          const vh = window.innerHeight * 0.01;
          document.documentElement.style.setProperty('--vh', `${vh}px`);
          
          // Update body height
          document.body.style.height = `${window.innerHeight}px`;
          document.body.style.minHeight = `${window.innerHeight}px`;
        };
        
        // Set initial height
        setViewportHeight();
        
        // Update on resize (keyboard show/hide)
        const debouncedResize = () => {
          if (resizeTimer) cancelAnimationFrame(resizeTimer);
          resizeTimer = requestAnimationFrame(setViewportHeight);
        };
        window.addEventListener('resize', debouncedResize);
        window.addEventListener('orientationchange', debouncedResize);
        
        // Handle visual viewport changes
        if (window.visualViewport) {
          window.visualViewport.addEventListener('resize', debouncedResize);
        }
      }
    }
    
    // Reduce scroll position restores that can cause jumps on Safari
    try { if ('scrollRestoration' in history) { history.scrollRestoration = 'manual'; } } catch (_) {}

    // iOS Safari: prevent pull-to-refresh/bounce which looks like a page refresh
    (function() {
      const ua = navigator.userAgent || '';
      const isSafari = ua.includes('Safari') && !ua.includes('Chrome');
      const isIOS = /iP(ad|hone|od)/.test(ua);
      if (!(isSafari && isIOS)) return;

      let startY = 0;
      let startX = 0;
      let active = false;

      const onTouchStart = (e) => {
        if (!e.touches || e.touches.length !== 1) return;
        startY = e.touches[0].clientY;
        startX = e.touches[0].clientX;
        active = true;
      };

      const onTouchMove = (e) => {
        if (!active || !e.touches || e.touches.length !== 1) return;
        const currentY = e.touches[0].clientY;
        const deltaY = currentY - startY;
        const el = document.scrollingElement || document.documentElement;
        const atTop = el.scrollTop <= 0;
        const atBottom = Math.ceil(el.scrollTop + el.clientHeight) >= el.scrollHeight;
        const movingDown = deltaY > 0;
        const movingUp = deltaY < 0;

        // Prevent overscroll at the top (pull-to-refresh) or bottom bounce
        if ((atTop && movingDown) || (atBottom && movingUp)) {
          e.preventDefault();
        }
      };

      const onTouchEnd = () => { active = false; };

      document.addEventListener('touchstart', onTouchStart, { passive: false });
      document.addEventListener('touchmove', onTouchMove, { passive: false });
      document.addEventListener('touchend', onTouchEnd, { passive: true });
    })();
    
    // Enhanced Safari page preservation
    window.addEventListener('pagehide', function(e) {
      if (e.persisted) {
        console.log('üì± Page is being cached by Safari');
      } else {
        console.log('üì± Page might be discarded - preparing state');
        // Save critical state to localStorage if needed
        try {
          localStorage.setItem('flutter_app_state', JSON.stringify({
            timestamp: Date.now(),
            url: window.location.href
          }));
        } catch (e) {
          console.log('Could not save state:', e);
        }
      }
    });
    
    // Prevent Safari from reloading on focus
    window.addEventListener('focus', function(e) {
      console.log('üì± Window focused - maintaining state');
    });
    
    // iOS Safari specific: Prevent reload on tab switch
    if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
      // Enhanced keep-alive system for iOS PWA
      let keepAliveInterval;
      
      function startKeepAlive() {
        if (keepAliveInterval) clearInterval(keepAliveInterval);
        keepAliveInterval = setInterval(function() {
          if (!document.hidden) {
            // Multiple strategies to keep the page alive
            console.debug('üì± iOS PWA keep-alive ping');
            
            // 1. Touch localStorage to maintain storage connection
            try {
              localStorage.setItem('pwa_heartbeat', Date.now().toString());
            } catch(e) {}
            
            // 2. Dispatch a minimal event to keep event system active
            window.dispatchEvent(new CustomEvent('pwa-keepalive'));
            
            // 3. Minimal DOM interaction
            document.body.style.setProperty('--pwa-heartbeat', Date.now().toString());
          }
        }, 15000); // Every 15 seconds (more frequent for PWA)
      }
      
      function stopKeepAlive() {
        if (keepAliveInterval) {
          clearInterval(keepAliveInterval);
          keepAliveInterval = null;
        }
      }
      
      // Start keep-alive when page is visible
      if (!document.hidden) startKeepAlive();
      
      // Manage keep-alive based on visibility
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          console.log('üì± PWA going to background - reducing activity');
          stopKeepAlive();
        } else {
          console.log('üì± PWA returning to foreground - resuming keep-alive');
          startKeepAlive();
        }
      });
      
      // Prevent iOS Safari auto-refresh on return
      window.addEventListener('pageshow', function(e) {
        if (e.persisted) {
          console.log('üì± Page restored from iOS cache');
        } else {
          console.log('üì± Page reloaded - checking for saved state');
          try {
            const savedState = localStorage.getItem('flutter_app_state');
            if (savedState) {
              const state = JSON.parse(savedState);
              console.log('üì± Found saved state from:', new Date(state.timestamp));
            }
          } catch (e) {
            console.log('üì± No previous state found');
          }
        }
      });
    }
    
    // PWA-specific iOS optimizations
    if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) {
      console.log('üì± Running as PWA - applying enhanced optimizations');
      
      // PWA state persistence
      window.addEventListener('beforeunload', function() {
        try {
          sessionStorage.setItem('pwa_last_active', Date.now().toString());
          sessionStorage.setItem('pwa_url', window.location.href);
        } catch(e) {}
      });
      
      // Enhanced PWA restoration
      window.addEventListener('pageshow', function(e) {
        if (!e.persisted) {
          try {
            const lastActive = sessionStorage.getItem('pwa_last_active');
            const lastUrl = sessionStorage.getItem('pwa_url');
            if (lastActive && Date.now() - parseInt(lastActive) < 300000) { // 5 minutes
              console.log('üì± PWA restored within 5 minutes - maintaining context');
            }
          } catch(e) {}
        }
      });
      
      // PWA memory pressure handling
      window.addEventListener('pagehide', function(e) {
        if (!e.persisted) {
          // Force save critical Flutter state before PWA closes
          try {
            if (window.flutterCanvasKit && window.flutterCanvasKit._engine) {
              console.log('üì± Saving Flutter state before PWA suspension');
            }
          } catch(e) {}
        }
      });
    }
    
    // Initialize mobile optimizations
    document.addEventListener('DOMContentLoaded', function() {
      handleMobileViewport();
      
      // Safari-specific optimizations
      if (navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome')) {
        // Prevent zoom on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
          const now = (new Date()).getTime();
          if (now - lastTouchEnd <= 300) {
            event.preventDefault();
          }
          lastTouchEnd = now;
        }, false);
        
        // Prevent pull-to-refresh
        // Handled globally above; keep this minimal to avoid double prevention
      }
    });
  </script>
</head>
<body>
  <!-- Flutter Web App Container -->
  <div id="flutter_target"></div>

  <!-- White screen watchdog fallback -->
  <div id="boot-fallback">
    <div class="wrap">
      <div class="card">
        <h2>Launching‚Ä¶</h2>
        <p>If this takes too long, try switching rendering mode or reloading.</p>
        <div class="btn-row">
          <button class="btn" id="retry-reload">Reload</button>
          <button class="link" id="switch-renderer">Try alternate mode</button>
          <button class="link" id="clear-sw">Clear caches</button>
        </div>
        <p id="renderer-hint" style="font-size:12px; color:#9fb0c3; margin-top:10px;"></p>
      </div>
    </div>
  </div>

  <!-- Test PWA gate and clear data buttons removed -->

  <!-- iOS PWA Install Gate Overlay -->
  <div id="ios-pwa-gate" style="display: none;">
    <div class="wrap">
      <div class="card">
        <div class="logo">
          <img src="icons/Icon-192.png" alt="Logo">
          <div>
            <div class="title" style="font-weight:800; letter-spacing:.2px;">Mzansi Marketplace</div>
            <div class="subtitle" style="color: var(--brand-subtle); font-size: 13px;">Fast, app-like experience</div>
          </div>
        </div>
        <h1 id="pwa-title">Install to Home Screen</h1>
        <p id="pwa-description">For iPhone/iPad, add this app to your Home Screen for the best performance and fewer reloads.</p>
        <div class="performance-warning" style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 12px; margin: 16px 0; display: flex; align-items: center; gap: 8px;">
          <span style="font-size: 18px;">‚ö†Ô∏è</span>
          <div style="font-size: 13px; color: var(--brand-subtle);">
            <strong>Safari Performance Issues:</strong> Marketplace features like image uploads, real-time chat, and smooth scrolling work much better in the installed app.
          </div>
        </div>
        <ol class="steps">
          <li>Tap the Share icon in Safari.</li>
          <li>Choose "Add to Home Screen".</li>
          <li>Open the app from your Home Screen.</li>
        </ol>
        <div class="btn-row">
          <button class="btn" id="pwa-installed-btn" onclick="handlePWAInstalled()">‚úÖ I've installed it</button>
          <button class="link" id="pwa-skip-btn" onclick="handlePWASkip()">üåê Continue anyway</button>
          <button class="link" id="pwa-remind-later-btn" onclick="handlePWARemindLater()" style="font-size: 12px;">‚è∞ Remind me later</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Android APK banner -->
  <div id="android-apk-banner">
    <div class="inner">
      <img src="icons/Icon-192.png" alt="Logo" />
      <div>
        <div class="title">Get the Android app</div>
        <div class="sub" style="color:#9fb0c3; font-size: 13px;">Download the APK for the smoothest experience</div>
      </div>
      <button id="apk-download-btn" class="cta" onclick="handleAPKDownload()">üì± Download APK</button>
      <button id="apk-dismiss-btn" class="dismiss" onclick="handleAPKDismiss()">‚úï Dismiss</button>
    </div>
  </div>
  
  <!-- Enhanced Flutter Web Scripts -->
  <script src="flutter_init.js"></script>
  <script src="flutter.js" defer></script>
  <script>
    window.addEventListener('load', function(ev) {
      // Remove the blocking behavior entirely
      // if (window.__blockFlutter) {
      //   console.warn('iOS PWA gate active - blocking Flutter load in Safari tab');
      //   return;
      // }
      // Use the standard Flutter web initialization pattern
      console.log('Starting Flutter initialization...');
      
      // Enhanced Flutter initialization with better error handling
      const initFlutter = () => {
        try {
          // Use the configuration we set up
          const config = window.flutterConfiguration || { renderer: "canvaskit" };
          console.log('üöÄ Initializing Flutter with config:', config);
          
          // Check if Flutter is available
          if (window._flutter_loader || window.flutter?.loader) {
            const loader = window._flutter_loader || window.flutter.loader;
            console.log('üì± Using Flutter loader...');
            
            loader.load({
              serviceWorkerSettings: {
                serviceWorkerVersion: '1.0.0',
              },
              config: config,
              onEntrypointLoaded: function(engineInitializer) {
                console.log('üéØ Flutter entrypoint loaded');
                engineInitializer.initializeEngine(config).then(function(appRunner) {
                  console.log('‚úÖ Flutter engine initialized');
                  appRunner.runApp();
                  
                  // Dispatch custom event for iOS optimizations
                  document.dispatchEvent(new CustomEvent('flutter-initialized'));
                }).catch(function(error) {
                  console.error('‚ùå Flutter engine initialization failed:', error);
                  // Auto-fallback: if CanvasKit failed on iOS, switch to HTML and reload once
                  try {
                    const wasCanvas = (config && config.renderer === 'canvaskit');
                    if (isIOS && wasCanvas) {
                      localStorage.setItem('web_renderer_override', 'html');
                      const url = new URL(window.location.href);
                      url.searchParams.set('r', 'html');
                      return window.location.replace(url.toString());
                    }
                  } catch(_) {}
                  fallbackInit();
                });
              }
            });
          } else if (window.flutter) {
            console.log('üì± Using legacy flutter loader...');
            window.flutter.loader.loadEntrypoint({
              serviceWorker: {
                serviceWorkerVersion: '1.0.0',
              },
              config: config,
              onEntrypointLoaded: function(engineInitializer) {
                engineInitializer.initializeEngine(config).then(function(appRunner) {
                  appRunner.runApp();
                  document.dispatchEvent(new CustomEvent('flutter-initialized'));
                }).catch(function(error){
                  console.error('‚ùå Legacy engine init failed:', error);
                  try {
                    const wasCanvas = (config && config.renderer === 'canvaskit');
                    if (isIOS && wasCanvas) {
                      localStorage.setItem('web_renderer_override', 'html');
                      const url = new URL(window.location.href);
                      url.searchParams.set('r', 'html');
                      return window.location.replace(url.toString());
                    }
                  } catch(_) {}
                });
              }
            });
          } else {
            console.log('‚ö†Ô∏è Flutter loader not found, using fallback...');
            fallbackInit();
          }
        } catch (error) {
          console.error('‚ùå Flutter initialization error:', error);
          fallbackInit();
        }
      };
      
      // Fallback initialization for older Flutter versions
      const fallbackInit = () => {
        console.log('üîÑ Attempting fallback initialization...');
        const script = document.createElement('script');
        script.src = 'main.dart.js';
        script.type = 'application/javascript';
        script.onload = function() {
          console.log('‚úÖ Fallback: main.dart.js loaded');
          document.dispatchEvent(new CustomEvent('flutter-initialized'));
        };
        script.onerror = function() {
          console.error('‚ùå Fallback: Failed to load main.dart.js');
        };
        document.head.appendChild(script);
      };
      
      // Wait a bit for flutter.js to initialize
      setTimeout(initFlutter, 100);

      // Watchdog: if not initialized within 8s, show fallback overlay
      (function() {
        let booted = false;
        const alt = (window.flutterConfiguration?.renderer === 'html') ? 'canvaskit' : 'html';
        const hint = document.getElementById('renderer-hint');
        if (hint) hint.textContent = 'Current mode: ' + (window.flutterConfiguration?.renderer || 'unknown') + ' ‚Äî Alternate: ' + alt;
        const showFallback = () => {
          if (booted) return;
          const el = document.getElementById('boot-fallback');
          if (el) el.style.display = 'block';
        };
        const timer = setTimeout(showFallback, 8000);
        document.addEventListener('flutter-initialized', function(){ booted = true; clearTimeout(timer); });

        // Buttons
        document.addEventListener('DOMContentLoaded', function(){
          const reloadBtn = document.getElementById('retry-reload');
          const switchBtn = document.getElementById('switch-renderer');
          const clearBtn = document.getElementById('clear-sw');
          const altRenderer = alt;
          if (reloadBtn) reloadBtn.addEventListener('click', function(){ location.reload(); });
          if (switchBtn) switchBtn.addEventListener('click', function(){
            try { localStorage.setItem('web_renderer_override', altRenderer); } catch(_) {}
            const url = new URL(window.location.href);
            url.searchParams.set('r', altRenderer);
            window.location.href = url.toString();
          });
          if (clearBtn) clearBtn.addEventListener('click', function(){ window.location.href = '/clear_sw.html'; });
        });
      })();

      // Test PWA gate and clear data functions removed
      
      // üöÄ ENHANCED PWA INSTALL HANDLERS
      
      // Function to handle "I've installed it" button
      window.handlePWAInstalled = function() {
        console.log('‚úÖ User confirmed PWA installation');
        
        // Hide the gate
        var gate = document.getElementById('ios-pwa-gate');
        if (gate) gate.style.display = 'none';
        
        // Mark as permanently dismissed
        localStorage.setItem('pwa_gate_dismissed', '1');
        
        // Show success message
        showSuccessMessage('üéâ Awesome! Refreshing to load the installed app...');
        
        // Refresh to detect standalone mode
        setTimeout(function() {
          location.reload();
        }, 1500);
      };
      
      // Function to handle "Continue anyway" button
      window.handlePWASkip = function() {
        console.log('üåê User chose to continue without installing');
        
        // Hide the gate
        var gate = document.getElementById('ios-pwa-gate');
        if (gate) gate.style.display = 'none';
        
        // Show performance warning banner
        setTimeout(function() {
          showPerformanceWarning();
        }, 1000);
      };
      
      // Function to handle "Remind me later" button  
      window.handlePWARemindLater = function() {
        console.log('‚è∞ User chose to be reminded later');
        
        // Hide the gate
        var gate = document.getElementById('ios-pwa-gate');
        if (gate) gate.style.display = 'none';
        
        // Set session storage to avoid showing again this session
        sessionStorage.setItem('pwa_reminder_dismissed', '1');
        
        // Show friendly message
        showInfoMessage('üëç No problem! We\'ll remind you next time you visit.');
      };
      
      // üì± ANDROID APK HANDLERS
      
      // Function to handle APK download
      window.handleAPKDownload = function() {
        console.log('üì± User clicked APK download');
        
        // Show download message
        showInfoMessage('üì± APK download will be available soon! For now, use "Add to Home Screen" in Chrome.');
        
        // Hide the banner
        var banner = document.getElementById('android-apk-banner');
        if (banner) banner.style.display = 'none';
        
        // Try to trigger the native browser install prompt
        if (window.deferredPrompt) {
          window.deferredPrompt.prompt();
          window.deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              showSuccessMessage('üéâ Thanks for installing the app!');
            }
            window.deferredPrompt = null;
          });
        } else {
          // Show browser install instructions
          setTimeout(function() {
            showAndroidInstallInstructions();
          }, 1000);
        }
      };
      
      // Function to handle APK dismiss
      window.handleAPKDismiss = function() {
        console.log('‚úï User dismissed APK banner');
        
        // Hide the banner
        var banner = document.getElementById('android-apk-banner');
        if (banner) banner.style.display = 'none';
        
        // Remember dismissal
        sessionStorage.setItem('apk_banner_dismissed', '1');
      };
      
      // Function to show Android install instructions
      function showAndroidInstallInstructions() {
        var modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:2147483647;display:flex;align-items:center;justify-content:center;padding:20px;';
        modal.innerHTML = `
          <div style="background:#fff;border-radius:12px;max-width:400px;padding:24px;text-align:center;">
            <h3 style="margin:0 0 16px;color:#1f2937;">üì± Install on Android</h3>
            <div style="text-align:left;margin:16px 0;">
              <div style="margin:8px 0;display:flex;align-items:center;gap:8px;">
                <span style="background:#3b82f6;color:#fff;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;">1</span>
                <span>Tap the menu (‚ãÆ) in Chrome</span>
              </div>
              <div style="margin:8px 0;display:flex;align-items:center;gap:8px;">
                <span style="background:#3b82f6;color:#fff;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;">2</span>
                <span>Tap "Add to Home screen"</span>
              </div>
              <div style="margin:8px 0;display:flex;align-items:center;gap:8px;">
                <span style="background:#3b82f6;color:#fff;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;">3</span>
                <span>Tap "Add" to confirm</span>
              </div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" style="background:#3b82f6;color:#fff;border:none;padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;margin-top:16px;">Got it!</button>
          </div>
        `;
        document.body.appendChild(modal);
        
        // Auto-remove after 10 seconds
        setTimeout(function() {
          if (modal.parentElement) modal.remove();
        }, 10000);
      }
      
      // Function to show success message
      function showSuccessMessage(message) {
        var success = document.createElement('div');
        success.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#22c55e;color:#fff;padding:12px 20px;border-radius:8px;font-weight:600;z-index:2147483648;box-shadow:0 4px 12px rgba(0,0,0,0.3);animation:slideDown 0.3s ease;';
        success.innerHTML = message;
        document.body.appendChild(success);
        
        setTimeout(function() {
          success.style.animation = 'slideUp 0.3s ease forwards';
          setTimeout(function() { success.remove(); }, 300);
        }, 2000);
      }
      
      // Function to show info message
      function showInfoMessage(message) {
        var info = document.createElement('div');
        info.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#3b82f6;color:#fff;padding:12px 20px;border-radius:8px;font-weight:600;z-index:2147483648;box-shadow:0 4px 12px rgba(0,0,0,0.3);animation:slideDown 0.3s ease;';
        info.innerHTML = message;
        document.body.appendChild(info);
        
        setTimeout(function() {
          info.style.animation = 'slideUp 0.3s ease forwards';
          setTimeout(function() { info.remove(); }, 300);
        }, 3000);
      }
      
      // Function to show performance warning
      function showPerformanceWarning() {
        if (document.getElementById('safari-warning')) return;
        
        var warning = document.createElement('div');
        warning.id = 'safari-warning';
        warning.style.cssText = 'position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#f59e0b,#d97706);color:#000;text-align:center;padding:12px;font-size:13px;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,0.15);';
        warning.innerHTML = `
          <div style="max-width:600px;margin:0 auto;display:flex;align-items:center;justify-content:center;gap:8px;">
            <span style="font-size:16px;">‚ö†Ô∏è</span>
            <span><strong>Safari Mode:</strong> Some features may be slower. <strong>Install the app for 3x better performance!</strong></span>
            <button onclick="this.parentElement.parentElement.remove()" style="background:rgba(0,0,0,0.1);border:none;padding:4px 8px;border-radius:4px;margin-left:8px;cursor:pointer;font-weight:bold;">‚úï</button>
          </div>
        `;
        document.body.appendChild(warning);
        
        // Auto-hide after 8 seconds
        setTimeout(function() {
          if (warning.parentElement) warning.remove();
        }, 8000);
      }
      
      // üöÄ NATIVE BROWSER INSTALL PROMPT HANDLING
      
      // Capture the native install prompt
      window.addEventListener('beforeinstallprompt', (e) => {
        console.log('üéØ Native install prompt available');
        
        // Prevent the mini-infobar from appearing on mobile
        e.preventDefault();
        
        // Stash the event so it can be triggered later
        window.deferredPrompt = e;
        
        // Show our custom install button if user hasn't installed yet
        if (!window.matchMedia('(display-mode: standalone)').matches) {
          showCustomInstallButton();
        }
      });
      
      // Listen for app installation
      window.addEventListener('appinstalled', (evt) => {
        console.log('üéâ PWA was installed successfully');
        showSuccessMessage('üéâ App installed successfully! Enjoy the better experience!');
        
        // Hide any install prompts
        var gate = document.getElementById('ios-pwa-gate');
        var banner = document.getElementById('android-apk-banner');
        var customBtn = document.getElementById('custom-install-btn');
        
        if (gate) gate.style.display = 'none';
        if (banner) banner.style.display = 'none';
        if (customBtn) customBtn.remove();
        
        // Mark as installed
        localStorage.setItem('pwa_gate_dismissed', '1');
      });
      
      // Function to show custom install button
      function showCustomInstallButton() {
        // Don't show if already exists or user dismissed
        if (document.getElementById('custom-install-btn') || 
            sessionStorage.getItem('install_btn_dismissed')) return;
            
        var installBtn = document.createElement('div');
        installBtn.id = 'custom-install-btn';
        installBtn.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#22c55e;color:#fff;padding:12px 16px;border-radius:50px;cursor:pointer;z-index:1000;box-shadow:0 4px 12px rgba(34,197,94,0.4);font-weight:600;display:flex;align-items:center;gap:8px;animation:slideInFromRight 0.5s ease;';
        installBtn.innerHTML = `
          <span style="font-size:18px;">üì±</span>
          <span>Install App</span>
          <button onclick="document.getElementById('custom-install-btn').remove(); sessionStorage.setItem('install_btn_dismissed', '1');" style="background:rgba(255,255,255,0.2);border:none;border-radius:50%;width:20px;height:20px;color:#fff;cursor:pointer;margin-left:8px;">‚úï</button>
        `;
        
        installBtn.onclick = function(e) {
          e.stopPropagation();
          if (window.deferredPrompt) {
            window.deferredPrompt.prompt();
            window.deferredPrompt.userChoice.then((choiceResult) => {
              if (choiceResult.outcome === 'accepted') {
                console.log('‚úÖ User accepted the install prompt');
              } else {
                console.log('‚ùå User dismissed the install prompt');
              }
              window.deferredPrompt = null;
              installBtn.remove();
            });
          }
        };
        
        document.body.appendChild(installBtn);
        
        // Auto-hide after 10 seconds
        setTimeout(function() {
          if (installBtn.parentElement) {
            installBtn.style.animation = 'slideOutToRight 0.5s ease forwards';
            setTimeout(() => installBtn.remove(), 500);
          }
        }, 10000);
      }
      
      // Add CSS animations
      var style = document.createElement('style');
      style.textContent = `
        @keyframes slideDown {
          from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
          to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        @keyframes slideUp {
          from { transform: translateX(-50%) translateY(0); opacity: 1; }
          to { transform: translateX(-50%) translateY(-100%); opacity: 0; }
        }
        @keyframes slideInFromRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutToRight {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
      
      // Backup: Traditional event listeners for compatibility
      try {
        const installedBtn = document.getElementById('pwa-installed-btn');
        const skipBtn = document.getElementById('pwa-skip-btn');
        const remindBtn = document.getElementById('pwa-remind-later-btn');
        
        if (installedBtn && !installedBtn.onclick) {
          installedBtn.addEventListener('click', window.handlePWAInstalled);
        }
        if (skipBtn && !skipBtn.onclick) {
          skipBtn.addEventListener('click', window.handlePWASkip);
        }
        if (remindBtn && !remindBtn.onclick) {
          remindBtn.addEventListener('click', window.handlePWARemindLater);
        }
      } catch(_) {}
    });
  </script>
</body>
</html>
