import 'dart:async';
import 'package:flutter/material.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:cloud_firestore/cloud_firestore.dart' show Timestamp;
import 'package:geolocator/geolocator.dart';
import 'package:geocoding/geocoding.dart';
import 'package:firebase_analytics/firebase_analytics.dart';
import 'package:url_launcher/url_launcher.dart';
import 'dart:io';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'package:provider/provider.dart';
import '../services/notification_service.dart';
import '../theme/app_theme.dart';
import '../widgets/rural_delivery_widget.dart';
import '../services/rural_delivery_service.dart';
import '../widgets/urban_delivery_widget.dart';
import '../services/urban_delivery_service.dart';
import '../services/delivery_fulfillment_service.dart';
import '../widgets/home_navigation_button.dart';

import '../providers/cart_provider.dart';
import 'login_screen.dart';
import 'OrderTrackingScreen.dart';

class CheckoutScreen extends StatefulWidget {
  final double totalPrice;

  const CheckoutScreen({super.key, required this.totalPrice});

  @override
  State<CheckoutScreen> createState() => _CheckoutScreenState();
}

class _CheckoutScreenState extends State<CheckoutScreen> {
  final _formKey = GlobalKey<FormState>();
  final _nameController = TextEditingController();
  final _addressController = TextEditingController();
  final _phoneController = TextEditingController();
  final _deliveryInstructionsController = TextEditingController();
  final _addressFocusNode = FocusNode();

  bool _isLoading = false;
  bool _orderCompleted = false; // Prevent duplicate orders
  String? _validatedAddress;
  bool _paymentMethodsLoaded = false;
  double? _deliveryFee;
  double _deliveryDistance = 0.0;
  bool? _storeOpen;
  String? _storeName;
  double? _minOrderForDelivery;
  String? _deliveryTimeEstimate;
  int? _deliveryStartHour;
  int? _deliveryEndHour;
  String? _storeOpenHour;
  String? _storeCloseHour;
  List<String> _paymentMethods = [];
  List<String> _excludedZones = [];
  double? _platformFeePercent;
  double _platformFee = 0.0;
  bool _isStoreFeeExempt = false;
  int? _deliveryTimeMinutes;
  String? _selectedPaymentMethod;
  bool _isDelivery = true; // Default to delivery, user can change to pickup
  
  // Rural delivery variables
  bool _isRuralArea = false;
  String? _selectedRuralDeliveryType;
  double _ruralDeliveryFee = 0.0;
  
  // Urban delivery variables
  bool _isUrbanArea = false;
  String? _selectedUrbanDeliveryType;
  double _urbanDeliveryFee = 0.0;
  String _productCategory = 'other'; // Default category
  
  // Address search variables
  List<Placemark> _addressSuggestions = [];
  Timer? _addressSearchTimer;
  bool _isSearchingAddress = false;

  User? get currentUser => FirebaseAuth.instance.currentUser;

  // PayFast configuration for development/sandbox
  static const String payfastMerchantId = '10004002';
  static const String payfastMerchantKey = 'q1cd2rdny4a53';
  static const String payfastReturnUrl = 'https://your-app.com/payment/success';
  static const String payfastCancelUrl = 'https://your-app.com/payment/cancel';
  static const String payfastNotifyUrl = 'https://your-app.com/payment/notify';
  static const bool payfastSandbox = true; // Set to false for production

  @override
  void initState() {
    super.initState();
    _orderCompleted = false; // Reset order completion flag
    if (currentUser != null) {
      _calculateDeliveryFeeAndCheckStore();
    }
    _addressFocusNode.addListener(() {
      if (!_addressFocusNode.hasFocus) {
        _calculateDeliveryFeeAndCheckStore();
      }
    });
  }

  @override
  void dispose() {
    _nameController.dispose();
    _addressController.dispose();
    _phoneController.dispose();
    _deliveryInstructionsController.dispose();
    _addressFocusNode.dispose();
    _addressSearchTimer?.cancel();
    super.dispose();
  }

  // Inline address search functionality
  void _searchAddressesInline(String query) {
    _addressSearchTimer?.cancel();
    _addressSearchTimer = Timer(const Duration(milliseconds: 500), () async {
      if (query.trim().length < 3) {
        setState(() {
          _addressSuggestions = [];
          _isSearchingAddress = false;
        });
        return;
      }

      setState(() {
        _isSearchingAddress = true;
      });

      print('üîç Searching for address: $query');

      try {
        // Search for addresses using geocoding
        final locations = await locationFromAddress(query);
        print('üîç Found ${locations.length} locations for query: $query');
        
        if (locations.isNotEmpty) {
          // Get detailed address information for each location
          List<Placemark> placemarks = [];
          for (final location in locations.take(5)) { // Limit to 5 results
            try {
              // Check for null coordinates
              if (location.latitude == null || location.longitude == null) {
                print('‚ö†Ô∏è Warning: Location has null coordinates');
                continue;
              }
              
              print('üîç Getting placemark for coordinates: ${location.latitude}, ${location.longitude}');
              final placemarkList = await placemarkFromCoordinates(
                location.latitude!,
                location.longitude!,
              );
              if (placemarkList.isNotEmpty) {
                placemarks.addAll(placemarkList);
                print('üîç Added ${placemarkList.length} placemarks');
              }
            } catch (e) {
              print('‚ùå Error getting placemark for location: $e');
            }
          }
          
          print('üîç Total placemarks found: ${placemarks.length}');
          setState(() {
            _addressSuggestions = placemarks;
            _isSearchingAddress = false;
          });
        } else {
          print('üîç No locations found for query: $query');
          setState(() {
            _addressSuggestions = [];
            _isSearchingAddress = false;
          });
        }
      } catch (e) {
        print('‚ùå Error searching addresses: $e');
        setState(() {
          _addressSuggestions = [];
          _isSearchingAddress = false;
        });
      }
    });
  }

  String _formatAddress(Placemark placemark) {
    List<String> parts = [];
    
    if (placemark.street != null && placemark.street!.isNotEmpty) {
      parts.add(placemark.street!);
    }
    if (placemark.subLocality != null && placemark.subLocality!.isNotEmpty) {
      parts.add(placemark.subLocality!);
    }
    if (placemark.locality != null && placemark.locality!.isNotEmpty) {
      parts.add(placemark.locality!);
    }
    if (placemark.administrativeArea != null && placemark.administrativeArea!.isNotEmpty) {
      parts.add(placemark.administrativeArea!);
    }
    if (placemark.postalCode != null && placemark.postalCode!.isNotEmpty) {
      parts.add(placemark.postalCode!);
    }
    
    return parts.join(', ');
  }



  Future<void> _calculateDeliveryFeeAndCheckStore() async {
    if (currentUser == null) {
      print('üîç DEBUG: No current user, skipping delivery calculation');
      return;
    }
    
    try {
      print('üîç DEBUG: Starting delivery fee calculation...');
      
      // Fetch cart items to get seller info
      final cartSnapshot = await FirebaseFirestore.instance
          .collection('users')
          .doc(currentUser!.uid)
          .collection('cart')
          .get();
      
      if (cartSnapshot.docs.isEmpty) {
        print('üîç DEBUG: No cart items found');
        return;
      }
      
      final firstItem = cartSnapshot.docs.first.data();
      final ownerId = firstItem['sellerId'] ?? firstItem['ownerId'];
      if (ownerId == null) {
        print('üîç DEBUG: No seller ID found in cart item');
        return;
      }
      
      print('üîç DEBUG: Seller ID: $ownerId');
      
      final sellerDoc = await FirebaseFirestore.instance
          .collection('users')
          .doc(ownerId)
          .get();
      
      if (!sellerDoc.exists) {
        print('üîç DEBUG: Seller document does not exist');
        return;
      }
      
      final seller = sellerDoc.data()!;
      _storeName = seller['storeName'] ?? 'Store';
      _storeOpen = seller['isStoreOpen'] ?? false;
      final storeLat = seller['latitude'];
      final storeLng = seller['longitude'];
      final deliveryFeePerKm = (seller['deliveryFeePerKm'] ?? 5.0).toDouble();
      print('üîç DEBUG: Raw deliveryFeePerKm from seller: ${seller['deliveryFeePerKm']}');
      print('üîç DEBUG: Converted deliveryFeePerKm: $deliveryFeePerKm');
      _minOrderForDelivery = (seller['minOrderForDelivery'] ?? 0.0).toDouble();
      _deliveryTimeEstimate = seller['deliveryTimeEstimate'] ?? '';
      // Convert string time to hour integer
      final deliveryStartHourStr = seller['deliveryStartHour'] ?? '08:00';
      final deliveryEndHourStr = seller['deliveryEndHour'] ?? '17:00';
      
      _deliveryStartHour = int.tryParse(deliveryStartHourStr.split(':')[0]) ?? 8;
      _deliveryEndHour = int.tryParse(deliveryEndHourStr.split(':')[0]) ?? 17;
      _storeOpenHour = seller['storeOpenHour'] ?? '08:00';
      _storeCloseHour = seller['storeCloseHour'] ?? '18:00';
      
      // Debug operating hours loading
      print('üîç DEBUG: Operating hours loaded:');
      print('  - storeOpenHour: $_storeOpenHour');
      print('  - storeCloseHour: $_storeCloseHour');
      print('  - seller storeOpenHour: ${seller['storeOpenHour']}');
      print('  - seller storeCloseHour: ${seller['storeCloseHour']}');
      _paymentMethods = List<String>.from(seller['paymentMethods'] ?? ['Cash on Delivery', 'PayFast']);
      _excludedZones = List<String>.from(seller['excludedZones'] ?? []);
      
      // Debug payment methods loading
      print('üîç DEBUG: Payment methods loaded: $_paymentMethods');
      print('üîç DEBUG: Seller data: ${seller['paymentMethods']}');
      print('üîç DEBUG: Payment methods count: ${_paymentMethods.length}');
      
      if (storeLat == null || storeLng == null) {
        print('üîç DEBUG: Store location not available, using default delivery fee');
        _deliveryFee = 15.0; // Default delivery fee
        _deliveryDistance = 5.0; // Default distance
        setState(() {});
        return;
      }
      
      print('üîç DEBUG: Store location - Lat: $storeLat, Lng: $storeLng');
      
      // Get user location and calculate delivery
      try {
        Position userPos = await Geolocator.getCurrentPosition(
          desiredAccuracy: LocationAccuracy.high,
        );
        print('üîç DEBUG: User location - Lat: ${userPos.latitude}, Lng: ${userPos.longitude}');
        
        _deliveryDistance = Geolocator.distanceBetween(
          userPos.latitude, userPos.longitude, storeLat, storeLng,
        ) / 1000;
        _deliveryFee = _deliveryDistance * deliveryFeePerKm;
        
        print('üîç DEBUG: Delivery calculation:');
        print('  - Distance: ${_deliveryDistance.toStringAsFixed(2)} km');
        print('  - Fee per km: R${deliveryFeePerKm.toStringAsFixed(2)}');
        print('  - Delivery fee: R${(_deliveryFee ?? 0.0).toStringAsFixed(2)}');
        print('  - Is delivery: $_isDelivery');
      } catch (e) {
        print('üîç DEBUG: Error getting user location: $e');
        print('üîç DEBUG: Using default delivery fee due to location error');
        _deliveryFee = 15.0; // Default delivery fee
        _deliveryDistance = 5.0; // Default distance
      }
      
      // Ensure delivery fee is always set for delivery mode
      if (_isDelivery && (_deliveryFee == null || _deliveryFee == 0.0)) {
        print('üîç DEBUG: Delivery fee is null or zero, setting default');
        _deliveryFee = 15.0;
        _deliveryDistance = 5.0;
      }
      
      // Check if this is a rural area and calculate rural delivery options
      _isRuralArea = RuralDeliveryService.isRuralArea(_deliveryDistance);
      
      if (_isRuralArea) {
        // Calculate rural delivery fee
        final ruralPricing = RuralDeliveryService.calculateRuralDeliveryFee(
          distance: _deliveryDistance,
          storeId: ownerId,
        );
        _ruralDeliveryFee = ruralPricing['finalFee'].toDouble();
        
        // Use rural delivery fee if it's better than standard fee
        if (_ruralDeliveryFee < (_deliveryFee ?? 0.0)) {
          _deliveryFee = _ruralDeliveryFee;
        }
        
        print('üîç DEBUG: Rural delivery calculation:');
        print('  - Is rural area: $_isRuralArea');
        print('  - Rural delivery fee: R${_ruralDeliveryFee.toStringAsFixed(2)}');
        print('  - Zone: ${ruralPricing['zoneName']}');
      }
      
      // Check if this is an urban area and calculate urban delivery options
      try {
        Position userPos = await Geolocator.getCurrentPosition(
          desiredAccuracy: LocationAccuracy.high,
        );
        
        _isUrbanArea = UrbanDeliveryService.isUrbanDeliveryZone(
          userPos.latitude, 
          userPos.longitude,
        );
        
        if (_isUrbanArea) {
          // Calculate urban delivery fee
          final urbanPricing = UrbanDeliveryService.calculateUrbanDeliveryFee(
            latitude: userPos.latitude,
            longitude: userPos.longitude,
            category: _productCategory,
            distance: _deliveryDistance,
            deliveryTime: DateTime.now(),
          );
          
          if (urbanPricing['isUrbanDelivery'] == true) {
            _urbanDeliveryFee = urbanPricing['fee'].toDouble();
            
            // Use urban delivery fee if it's better than standard fee
            if (_urbanDeliveryFee < (_deliveryFee ?? 0.0)) {
              _deliveryFee = _urbanDeliveryFee;
            }
            
            print('üîç DEBUG: Urban delivery calculation:');
            print('  - Is urban area: $_isUrbanArea');
            print('  - Urban delivery fee: R${_urbanDeliveryFee.toStringAsFixed(2)}');
            print('  - Zone: ${urbanPricing['zoneName']}');
            print('  - Category: $_productCategory');
          }
        }
      } catch (e) {
        print('üîç DEBUG: Error checking urban delivery: $e');
      }
      
      // Calculate realistic delivery time
      _deliveryTimeMinutes = _calculateRealisticDeliveryTime(
        distance: _deliveryDistance,
        basePrepTime: seller['preparationTimeMinutes'] ?? 15,
        currentTime: DateTime.now(),
      );
      
      await _fetchPlatformFeeConfigAndExemption(ownerId);
      
      // Ensure UI updates with new delivery fee
      setState(() {});
      print('üîç DEBUG: Delivery fee calculation completed');
    } finally {
      setState(() {
        _paymentMethodsLoaded = true;
      });
    }
  }

  int _calculateRealisticDeliveryTime({
    required double distance,
    required int basePrepTime,
    required DateTime currentTime,
  }) {
    // Base preparation time
    int totalMinutes = basePrepTime;
    
    // Add travel time (25 km/h average city speed)
    double travelHours = distance / 25.0;
    int travelMinutes = (travelHours * 60).round();
    totalMinutes += travelMinutes;
    
    // Factor in time of day
    int hour = currentTime.hour;
    if ((hour >= 7 && hour <= 9) || (hour >= 17 && hour <= 19)) {
      totalMinutes = (totalMinutes * 1.5).round(); // Rush hour
    } else if (hour >= 22 || hour <= 6) {
      totalMinutes = (totalMinutes * 0.8).round(); // Off-peak
    }
    
    // Factor in day of week
    int weekday = currentTime.weekday;
    if (weekday == DateTime.saturday || weekday == DateTime.sunday) {
      totalMinutes = (totalMinutes * 1.2).round(); // Weekend
    }
    
    // Add buffer time
    totalMinutes += 5;
    
    // Round to nearest 5 minutes
    totalMinutes = ((totalMinutes / 5).round() * 5);
    
    return totalMinutes.clamp(20, 120);
  }

  void _onRuralDeliveryOptionSelected(String deliveryType, double fee) {
    setState(() {
      _selectedRuralDeliveryType = deliveryType;
      _ruralDeliveryFee = fee;
      _deliveryFee = fee; // Update the main delivery fee
    });
    
    print('üîç DEBUG: Rural delivery option selected:');
    print('  - Type: $deliveryType');
    print('  - Fee: R${fee.toStringAsFixed(2)}');
  }
  
  void _onUrbanDeliveryOptionSelected(String deliveryType, double fee) {
    setState(() {
      _selectedUrbanDeliveryType = deliveryType;
      _urbanDeliveryFee = fee;
      _deliveryFee = fee; // Update the main delivery fee
    });
    
    print('üîç DEBUG: Urban delivery option selected:');
    print('  - Type: $deliveryType');
    print('  - Fee: R${fee.toStringAsFixed(2)}');
  }

  Future<void> _fetchPlatformFeeConfigAndExemption(String sellerId) async {
    try {
      final configDoc = await FirebaseFirestore.instance
          .collection('config')
          .doc('platform')
          .get();
      final configData = configDoc.data();
      if (configData != null && configData['platformFee'] != null) {
        _platformFeePercent = (configData['platformFee'] as num).toDouble();
      } else {
        _platformFeePercent = 5.0;
      }
    } catch (_) {
      _platformFeePercent = 5.0;
    }

    try {
      final sellerDoc = await FirebaseFirestore.instance
          .collection('users')
          .doc(sellerId)
          .get();
      final sellerData = sellerDoc.data();
      if (sellerData != null && sellerData['platformFeeExempt'] == true) {
        _isStoreFeeExempt = true;
      } else {
        _isStoreFeeExempt = false;
      }
    } catch (_) {}
  }

  bool _isStoreCurrentlyOpen() {
    if (_storeOpenHour == null || _storeCloseHour == null) {
      return _storeOpen ?? false; // Fallback to manual store open status
    }
    
    try {
      final now = DateTime.now();
      final currentTime = TimeOfDay(hour: now.hour, minute: now.minute);
      
      // Parse store hours
      final openParts = _storeOpenHour!.split(':');
      final closeParts = _storeCloseHour!.split(':');
      
      if (openParts.length != 2 || closeParts.length != 2) {
        return _storeOpen ?? false; // Fallback if time format is invalid
      }
      
      final openHour = int.parse(openParts[0]);
      final openMinute = int.parse(openParts[1]);
      final closeHour = int.parse(closeParts[0]);
      final closeMinute = int.parse(closeParts[1]);
      
      final openTime = TimeOfDay(hour: openHour, minute: openMinute);
      final closeTime = TimeOfDay(hour: closeHour, minute: closeMinute);
      
      // Convert to minutes for easier comparison
      final currentMinutes = currentTime.hour * 60 + currentTime.minute;
      final openMinutes = openTime.hour * 60 + openTime.minute;
      final closeMinutes = closeTime.hour * 60 + closeTime.minute;
      
      // Handle cases where store is open past midnight
      if (closeMinutes < openMinutes) {
        // Store closes after midnight
        return currentMinutes >= openMinutes || currentMinutes <= closeMinutes;
      } else {
        // Store closes on the same day
        return currentMinutes >= openMinutes && currentMinutes <= closeMinutes;
      }
    } catch (e) {
      print('üîç DEBUG: Error checking store hours: $e');
      return _storeOpen ?? false; // Fallback to manual store open status
    }
  }


  Future<void> _submitOrder() async {
    if (_isLoading || _orderCompleted) return; // Prevent multiple submissions
    if (!_formKey.currentState!.validate()) return;
    if (_selectedPaymentMethod == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Please select a payment method')),
      );
      return;
    }

    print('üîç DEBUG: _submitOrder called with payment method: $_selectedPaymentMethod');

    if (currentUser == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Please log in to place an order')),
      );
      Navigator.push(
        context,
        MaterialPageRoute(builder: (_) => const LoginScreen()),
      );
      return;
    }

    // Log checkout event
    FirebaseAnalytics.instance.logEvent(
      name: 'checkout',
      parameters: {'totalPrice': widget.totalPrice},
    );

    // Validate order before payment
    print('üîç DEBUG: Validating order before payment...');
    if (!await _validateOrderBeforePayment()) {
      print('üîç DEBUG: Order validation failed');
      return;
    }
    print('üîç DEBUG: Order validation passed');

    // Handle different payment methods
    if (_selectedPaymentMethod?.toLowerCase().contains('payfast') == true || 
        _selectedPaymentMethod?.toLowerCase().contains('card') == true ||
        _selectedPaymentMethod?.toLowerCase().contains('eft') == true) {
      print('üîç DEBUG: Processing PayFast/Card/EFT payment');
      await _processPayFastPayment();
    } else {
      // For cash/other payment methods, complete order directly
      print('üîç DEBUG: Processing cash/other payment - calling _completeOrder');
      await _completeOrder();
    }
  }

  Future<bool> _validateOrderBeforePayment() async {
    try {
      // Check delivery zones
    if (_excludedZones.isNotEmpty) {
      final address = _addressController.text.toLowerCase();
      final blocked = _excludedZones.any((zone) => address.contains(zone.toLowerCase()));
      if (blocked) {
        ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('Delivery is not available to your address')),
        );
          return false;
      }
    }

      // Check minimum order
    if (_minOrderForDelivery != null && widget.totalPrice < _minOrderForDelivery!) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Minimum order for delivery is R${_minOrderForDelivery!.toStringAsFixed(2)}')),
      );
        return false;
      }

      // Check cart and stock
      final cartSnapshot = await FirebaseFirestore.instance
          .collection('users')
          .doc(currentUser!.uid)
          .collection('cart')
          .get();
      
      if (cartSnapshot.docs.isEmpty) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Your cart is empty')),
        );
        return false;
      }

      // Stock check
      for (final doc in cartSnapshot.docs) {
        final item = doc.data();
        final productId = item['id'] ?? item['productId'];
        if (productId == null) continue;
        
        final productDoc = await FirebaseFirestore.instance
            .collection('products')
            .doc(productId)
            .get();
        
        if (!productDoc.exists) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(content: Text('Product not found: ${item['name'] ?? productId}')),
          );
          return false;
        }
        
        final product = productDoc.data()!;
        final stock = product['stock'] ?? 999999;
        final quantity = item['quantity'] ?? 1;
        
        if (quantity > stock) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(content: Text('Not enough stock for ${item['name'] ?? 'an item'}')),
          );
          return false;
        }
      }

      return true;
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Error validating order: ${e.toString()}')),
      );
      return false;
    }
  }

  Future<void> _processPayFastPayment() async {
    setState(() => _isLoading = true);

    try {
      // Generate order info
      final now = DateTime.now();
      final orderNumber = 'ORD-${now.day.toString().padLeft(2, '0')}${now.month.toString().padLeft(2, '0')}${now.year}-${now.hour.toString().padLeft(2, '0')}${now.minute.toString().padLeft(2, '0')}-${currentUser!.uid.substring(0, 3).toUpperCase()}';
      final totalAmount = widget.totalPrice + (_isDelivery ? (_deliveryFee ?? 0.0) : 0.0);

      // Generate PayFast URL
      final paymentUrl = _generatePayFastUrl(
        orderId: orderNumber,
        amount: totalAmount,
        buyerEmail: currentUser!.email ?? 'test@example.com',
        buyerName: _nameController.text.trim().isNotEmpty 
            ? _nameController.text.trim() 
            : 'Customer',
      );

      setState(() => _isLoading = false);

      // Show payment confirmation
      final shouldProceed = await _showPaymentConfirmationDialog(totalAmount);
      if (!shouldProceed) return;

      // Launch PayFast
      await _launchPayFastPayment(paymentUrl, orderNumber);

    } catch (e) {
      setState(() => _isLoading = false);
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Payment setup failed: ${e.toString()}')),
      );
    }
  }

  String _generatePayFastUrl({
    required String orderId,
    required double amount,
    required String buyerEmail,
    required String buyerName,
  }) {
    final params = {
      'merchant_id': payfastMerchantId,
      'merchant_key': payfastMerchantKey,
      'return_url': payfastReturnUrl,
      'cancel_url': payfastCancelUrl,
      'notify_url': payfastNotifyUrl,
      'amount': amount.toStringAsFixed(2),
      'item_name': 'Food Order $orderId',
      'name_first': buyerName.split(' ').first,
      'name_last': buyerName.split(' ').length > 1 ? buyerName.split(' ').last : '',
      'email_address': buyerEmail,
      'm_payment_id': orderId,
      'custom_str1': orderId,
      'custom_str2': currentUser!.uid,
    };
    
    final query = params.entries
        .map((e) => '${Uri.encodeComponent(e.key)}=${Uri.encodeComponent(e.value)}')
        .join('&');
    
    // Use sandbox for development
    if (payfastSandbox) {
      return 'https://sandbox.payfast.co.za/eng/process?$query';
    } else {
      return 'https://www.payfast.co.za/eng/process?$query';
    }
  }

  Future<bool> _showPaymentConfirmationDialog(double totalAmount) async {
    return await showDialog<bool>(
      context: context,
      barrierDismissible: false,
      builder: (BuildContext context) {
        return AlertDialog(
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
          title: Row(
            children: [
              Container(
                padding: const EdgeInsets.all(8),
                decoration: BoxDecoration(
                  gradient: AppTheme.primaryButtonGradient,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Icon(
                  Icons.payment,
                  color: AppTheme.angel,
                  size: 24,
                ),
              ),
              const SizedBox(width: 12),
              SafeUI.safeText(
                'Confirm Payment',
                style: TextStyle(
                  fontSize: ResponsiveUtils.getTitleSize(context),
                  fontWeight: FontWeight.w600,
                  color: AppTheme.deepTeal,
                ),
                maxLines: 1,
              ),
            ],
          ),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              SafeUI.safeText(
                'You will be redirected to PayFast to complete your payment.',
                style: TextStyle(
                  fontSize: ResponsiveUtils.getTitleSize(context) - 2,
                  color: AppTheme.breeze,
                ),
                maxLines: 3,
              ),
              const SizedBox(height: 16),
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [AppTheme.whisper, AppTheme.angel],
                  ),
                  borderRadius: BorderRadius.circular(8),
                  border: Border.all(
                    color: AppTheme.breeze.withOpacity(0.3),
                    width: 1,
                  ),
                ),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    SafeUI.safeText(
                      'Total Amount:',
                      style: TextStyle(
                        fontSize: ResponsiveUtils.getTitleSize(context),
                        fontWeight: FontWeight.w600,
                        color: AppTheme.deepTeal,
                      ),
                      maxLines: 1,
                    ),
                    SafeUI.safeText(
                      'R${totalAmount.toStringAsFixed(2)}',
                      style: TextStyle(
                        fontSize: ResponsiveUtils.getTitleSize(context) + 2,
                        fontWeight: FontWeight.bold,
                        color: AppTheme.deepTeal,
                      ),
                      maxLines: 1,
                    ),
                  ],
                ),
              ),
            ],
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(false),
              child: SafeUI.safeText(
                'Cancel',
                style: TextStyle(color: AppTheme.breeze),
                maxLines: 1,
              ),
            ),
            Container(
              decoration: BoxDecoration(
                gradient: AppTheme.primaryButtonGradient,
                borderRadius: BorderRadius.circular(8),
              ),
              child: TextButton(
                onPressed: () => Navigator.of(context).pop(true),
                child: SafeUI.safeText(
                  'Continue to Payment',
                  style: TextStyle(
                    color: AppTheme.angel,
                    fontWeight: FontWeight.w600,
                  ),
                  maxLines: 1,
                ),
              ),
            ),
          ],
        );
      },
    ) ?? false;
  }

  Future<void> _launchPayFastPayment(String paymentUrl, String orderNumber) async {
    try {
      final uri = Uri.parse(paymentUrl);
      if (await canLaunchUrl(uri)) {
        await launchUrl(uri, mode: LaunchMode.externalApplication);
        
        // Show return dialog
        if (mounted) {
          _showPaymentReturnDialog(orderNumber);
        }
      } else {
        throw 'Could not launch PayFast payment URL';
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Could not open payment gateway: ${e.toString()}')),
      );
    }
  }

  void _showPaymentReturnDialog(String orderNumber) {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (BuildContext context) {
        return AlertDialog(
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
          title: Row(
            children: [
              Icon(Icons.payment, color: AppTheme.deepTeal),
              const SizedBox(width: 8),
              SafeUI.safeText(
                'Payment Status',
                style: TextStyle(
                  color: AppTheme.deepTeal,
                  fontWeight: FontWeight.w600,
                ),
                maxLines: 1,
              ),
            ],
          ),
          content: SafeUI.safeText(
            'Did you complete the payment successfully?',
            style: TextStyle(
              fontSize: ResponsiveUtils.getTitleSize(context) - 2,
              color: AppTheme.breeze,
            ),
            maxLines: 2,
          ),
          actions: [
            TextButton(
              onPressed: () {
                Navigator.of(context).pop();
                // Payment cancelled - stay on checkout screen
              },
              child: SafeUI.safeText(
                'Payment Failed',
                style: TextStyle(color: AppTheme.warmAccentColor),
                maxLines: 1,
              ),
            ),
            Container(
              decoration: BoxDecoration(
                gradient: AppTheme.primaryButtonGradient,
                borderRadius: BorderRadius.circular(8),
              ),
              child: TextButton(
                onPressed: () {
                  Navigator.of(context).pop();
                  // Payment successful - complete the order
                  _completeOrder();
                },
                child: SafeUI.safeText(
                  'Payment Success',
                  style: TextStyle(
                    color: AppTheme.angel,
                    fontWeight: FontWeight.w600,
                  ),
                  maxLines: 1,
                ),
              ),
            ),
          ],
        );
      },
    );
  }

  Future<void> _completeOrder() async {
    // Prevent duplicate orders
    if (_orderCompleted) {
      print('üîç DEBUG: Order already completed, preventing duplicate');
      return;
    }
    
    // Check if store is currently open
    if (!_isStoreCurrentlyOpen()) {
      print('üîç DEBUG: Store is currently closed');
      setState(() => _isLoading = false);
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Sorry, ${_storeName ?? 'the store'} is currently closed. Please try again during business hours.'),
            backgroundColor: Colors.red,
            duration: const Duration(seconds: 5),
          ),
        );
      }
      return;
    }
    
    print('üîç DEBUG: Starting _completeOrder for payment method: $_selectedPaymentMethod');
    setState(() => _isLoading = true);

    try {
      // Fetch cart items
      final cartSnapshot = await FirebaseFirestore.instance
          .collection('users')
          .doc(currentUser!.uid)
          .collection('cart')
          .get();
      
      print('üîç DEBUG: Cart items found: ${cartSnapshot.docs.length}');
      final cartItems = cartSnapshot.docs.map((doc) => doc.data()).toList();
      
      var sellerId = cartItems.first['sellerId'] ?? cartItems.first['ownerId'] ?? '';
      if (sellerId.isEmpty && cartItems.first['productId'] != null) {
        final productDoc = await FirebaseFirestore.instance
            .collection('products')
            .doc(cartItems.first['productId'])
            .get();
        sellerId = productDoc.data()?['ownerId'] ?? productDoc.data()?['sellerId'] ?? '';
      }
      
      print('üîç DEBUG: Seller ID: $sellerId');

      // Generate order number
      final now = DateTime.now();
      final orderNumber = 'ORD-${now.day.toString().padLeft(2, '0')}${now.month.toString().padLeft(2, '0')}${now.year}-${now.hour.toString().padLeft(2, '0')}${now.minute.toString().padLeft(2, '0')}-${currentUser!.uid.substring(0, 3).toUpperCase()}';
      
      print('üîç DEBUG: Order number: $orderNumber');

      final pf = _platformFeePercent ?? 0.0;

      print('üîç DEBUG: Creating order in Firestore...');
      
      final orderRef = await FirebaseFirestore.instance.collection('orders').add({
        'orderNumber': orderNumber,
        'buyerId': currentUser!.uid,
        'sellerId': sellerId,
        'items': cartItems,
        'totalPrice': widget.totalPrice,
        'orderType': _isDelivery ? 'delivery' : 'pickup',
        'deliveryFee': _isDelivery ? (_deliveryFee ?? 0.0) : 0.0,
        'deliveryDistance': _deliveryDistance,
        'isRuralArea': _isRuralArea,
        'ruralDeliveryType': _selectedRuralDeliveryType,
        'ruralDeliveryFee': _isRuralArea ? _ruralDeliveryFee : 0.0,
        'isUrbanArea': _isUrbanArea,
        'urbanDeliveryType': _selectedUrbanDeliveryType,
        'urbanDeliveryFee': _isUrbanArea ? _urbanDeliveryFee : 0.0,
        'productCategory': _productCategory,
        'timestamp': FieldValue.serverTimestamp(),
        'name': _nameController.text.trim(),
        'buyerName': _nameController.text.trim(), // Add buyerName field for consistency
        'address': _addressController.text.trim(),
        'phone': _phoneController.text.trim(),
        'deliveryInstructions': _deliveryInstructionsController.text.trim(),
        'status': 'pending',
        'paymentMethod': _selectedPaymentMethod,
        'paymentStatus': _selectedPaymentMethod?.toLowerCase().contains('cash') == true ? 'pending' : 'paid',
        'platformFee': (!_isStoreFeeExempt) ? (widget.totalPrice * pf / 100) : 0.0,
        'platformFeePercent': pf,
        'platformFeeExempt': _isStoreFeeExempt,
        'sellerPayout': widget.totalPrice - ((!_isStoreFeeExempt) ? (widget.totalPrice * pf / 100) : 0.0),
        'trackingUpdates': [
          {
            'description': 'Order placed successfully',
            'timestamp': Timestamp.now(),
            'status': 'pending'
          }
        ],
      });

      print('üîç DEBUG: Order created successfully with ID: ${orderRef.id}');

                     // **AUTOMATED DRIVER ASSIGNMENT**
               Map<String, dynamic>? assignedDriver;
               if (_isDelivery && (_isRuralArea || _isUrbanArea)) {
                 try {
                   print('üîç DEBUG: Starting automated driver assignment...');
                   
                   // Get seller location (in real app, get from seller data)
                   final sellerLat = -26.1076; // Demo coordinates
                   final sellerLng = 28.0567;
                   
                   // Get delivery location from order (in real app, get from user's location)
                   final deliveryLat = -26.1076; // Demo coordinates - replace with actual user location
                   final deliveryLng = 28.0567;
                   
                   // Determine delivery type and category
                   String deliveryType = 'pickup';
                   if (_isRuralArea) {
                     deliveryType = 'rural';
                   } else if (_isUrbanArea) {
                     deliveryType = 'urban';
                   }
                   
                   // Assign driver to order
                   assignedDriver = await DeliveryFulfillmentService.assignDriverToOrder(
                     orderId: orderRef.id,
                     sellerId: sellerId,
                     pickupLatitude: sellerLat,
                     pickupLongitude: sellerLng,
                     deliveryLatitude: deliveryLat,
                     deliveryLongitude: deliveryLng,
                     deliveryType: deliveryType,
                     category: _productCategory,
                   );
                   
                   if (assignedDriver != null) {
                     print('üîç DEBUG: Driver ${assignedDriver['name']} assigned to order');
                     
                     // Update order with driver assignment
                     await orderRef.update({
                       'driverAssigned': true,
                       'assignedDriverId': assignedDriver['driverId'],
                     });
                   } else {
                     print('üîç DEBUG: No driver available, order will be manually assigned');
                   }
                 } catch (e) {
                   print('üîç DEBUG: Error in automated driver assignment: $e');
                 }
               }

               // Update notification message if driver was assigned
               String notificationMessage = 'Your order has been placed and is being processed. Track your order to see real-time updates.';
               if (assignedDriver != null) {
                 notificationMessage = 'üöö Driver ${assignedDriver['name']} has been assigned to your order! Track your order to see real-time updates.';
               }

      // Log purchase event
      FirebaseAnalytics.instance.logEvent(
        name: 'purchase',
        parameters: {'totalPrice': widget.totalPrice, 'sellerId': sellerId},
      );

      // Clear cart from Firestore
      for (var doc in cartSnapshot.docs) {
        await doc.reference.delete();
      }

      // Clear local cart provider
      final cartProvider = Provider.of<CartProvider>(context, listen: false);
      cartProvider.clearCart();

      _orderCompleted = true; // Mark order as completed
      setState(() => _isLoading = false);

      if (!mounted) return;

      // Show popup notification with driver information
      
      NotificationService.showPopupNotification(
        title: 'Order Placed Successfully! üéâ',
        message: notificationMessage,
        onTap: () {
          // Navigate to order tracking
          Navigator.pushReplacement(
            context,
            MaterialPageRoute(
              builder: (_) => OrderTrackingScreen(orderId: orderRef.id),
            ),
          );
        },
      );

      // Send notifications
      await _sendOrderNotifications(sellerId, orderRef.id, orderNumber);

      // Navigate to tracking
      Navigator.pushReplacement(
        context,
        MaterialPageRoute(
          builder: (_) => OrderTrackingScreen(orderId: orderRef.id),
        ),
      );
    } catch (e) {
      _orderCompleted = false; // Reset on error
      setState(() => _isLoading = false);
      debugPrint('Checkout error: $e');
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Failed to place order. Please try again.'),
          action: SnackBarAction(
            label: 'Retry',
            onPressed: _submitOrder,
          ),
        ),
      );
    }
  }

  Future<void> _sendOrderNotifications(String sellerId, String orderId, String orderNumber) async {
    try {
      // Get buyer name for the notification
      String buyerName = 'Customer';
      try {
        final buyerDoc = await FirebaseFirestore.instance
            .collection('users')
            .doc(currentUser!.uid)
            .get();
        final buyerData = buyerDoc.data();
        if (buyerData != null) {
          buyerName = buyerData['name'] ?? buyerData['email'] ?? 'Customer';
        }
      } catch (e) {
        debugPrint('Error getting buyer name: $e');
      }

      // Get seller name for buyer notification
      String sellerName = 'Store';
      try {
        final sellerDoc = await FirebaseFirestore.instance
            .collection('users')
            .doc(sellerId)
            .get();
        final sellerData = sellerDoc.data();
        if (sellerData != null) {
          sellerName = sellerData['storeName'] ?? sellerData['name'] ?? 'Store';
        }
      } catch (e) {
        debugPrint('Error getting seller name: $e');
      }

      // Send notification to seller (new order received)
      print('üîî Attempting to send seller notification...');
      await NotificationService().sendNewOrderNotificationToSeller(
        sellerId: sellerId,
        orderId: orderId,
        buyerName: buyerName,
        orderTotal: widget.totalPrice,
        sellerName: sellerName,
      );
      
      // Send notification to buyer (order placed)
      print('üîî Attempting to send buyer notification...');
      await NotificationService().sendOrderStatusNotificationToBuyer(
        buyerId: currentUser!.uid,
        orderId: orderId,
        status: 'pending',
        sellerName: sellerName,
      );
      
      // Test notification to verify system is working
      print('üîî Sending test notification...');
      await NotificationService().testNotification();
      
      print('‚úÖ Order notifications sent successfully');
    } catch (e) {
      debugPrint('‚ùå Error sending order notifications: $e');
    }
  }

  @override
  Widget build(BuildContext context) {
    if (!_paymentMethodsLoaded) {
      return Scaffold(
        appBar: AppBar(
          backgroundColor: AppTheme.deepTeal,
          foregroundColor: AppTheme.angel,
          elevation: 0,
          centerTitle: false,
          title: SafeUI.safeText(
            'Checkout',
            style: TextStyle(
              fontSize: ResponsiveUtils.getTitleSize(context),
              fontWeight: FontWeight.w600,
              color: AppTheme.angel,
            ),
            maxLines: 1,
          ),
          actions: [
            HomeNavigationButton(
              backgroundColor: AppTheme.deepTeal,
              iconColor: AppTheme.angel,
            ),
            const SizedBox(width: 16),
          ],
        ),
        body: Container(
          decoration: BoxDecoration(
            gradient: AppTheme.screenBackgroundGradient,
          ),
          child: const Center(
            child: CircularProgressIndicator(),
          ),
        ),
      );
    }

    // Ensure delivery fee is included when in delivery mode
    final deliveryFee = _isDelivery ? (_deliveryFee ?? 15.0) : 0.0;
    final grandTotal = widget.totalPrice + deliveryFee;
    
    // Debug logging for total calculation
    print('üîç DEBUG: Total calculation:');
    print('  - Subtotal: R${widget.totalPrice.toStringAsFixed(2)}');
    print('  - Is delivery: $_isDelivery');
    print('  - Raw delivery fee: R${(_deliveryFee ?? 0.0).toStringAsFixed(2)}');
    print('  - Final delivery fee: R${deliveryFee.toStringAsFixed(2)}');
    print('  - Grand total: R${grandTotal.toStringAsFixed(2)}');

    return Scaffold(
      appBar: AppBar(
        backgroundColor: AppTheme.deepTeal,
        foregroundColor: AppTheme.angel,
        elevation: 0,
        centerTitle: false,
        title: SafeUI.safeText(
          'Checkout',
          style: TextStyle(
            fontSize: ResponsiveUtils.getTitleSize(context),
            fontWeight: FontWeight.w600,
            color: AppTheme.angel,
          ),
          maxLines: 1,
        ),
        actions: [
          HomeNavigationButton(
            backgroundColor: AppTheme.deepTeal,
            iconColor: AppTheme.angel,
          ),
          const SizedBox(width: 16),
        ],
      ),
      body: Container(
        decoration: BoxDecoration(
          gradient: AppTheme.screenBackgroundGradient,
        ),
        child: Stack(
        children: [
          Form(
            key: _formKey,
              child: CustomScrollView(
                slivers: [
                  SliverPadding(
                    padding: EdgeInsets.all(ResponsiveUtils.getHorizontalPadding(context)),
                    sliver: SliverList(
                      delegate: SliverChildListDelegate([
                        _buildCheckoutHeader(),
                        SizedBox(height: ResponsiveUtils.getVerticalPadding(context)),
                        
                        _buildStoreInfoSection(),
                        SizedBox(height: ResponsiveUtils.getVerticalPadding(context)),
                        
                        _buildDeliverySection(),
                        SizedBox(height: ResponsiveUtils.getVerticalPadding(context)),
                        
                        _buildPaymentSection(),
                        SizedBox(height: ResponsiveUtils.getVerticalPadding(context)),
                        
                        _buildOrderSummary(grandTotal),
                        SizedBox(height: ResponsiveUtils.getVerticalPadding(context) * 2),
                        
                        _buildPlaceOrderButton(),
                        SizedBox(height: ResponsiveUtils.getVerticalPadding(context)),
                      ]),
                    ),
                  ),
                ],
              ),
            ),
            if (_isLoading)
              Container(
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [AppTheme.deepTeal.withOpacity(0.8), AppTheme.cloud.withOpacity(0.8)],
                  ),
                ),
                child: Center(
                  child: Container(
                    padding: EdgeInsets.all(ResponsiveUtils.getHorizontalPadding(context) * 2),
                    decoration: BoxDecoration(
                      gradient: AppTheme.cardBackgroundGradient,
                      borderRadius: BorderRadius.circular(16),
                      boxShadow: AppTheme.complementaryElevation,
                    ),
                    child: Column(
                      mainAxisSize: MainAxisSize.min,
              children: [
                        CircularProgressIndicator(
                          valueColor: AlwaysStoppedAnimation<Color>(AppTheme.deepTeal),
                        ),
                        SizedBox(height: ResponsiveUtils.getVerticalPadding(context)),
                        SafeUI.safeText(
                          'Processing your order...',
                          style: TextStyle(
                            fontSize: ResponsiveUtils.getTitleSize(context),
                            fontWeight: FontWeight.w600,
                            color: AppTheme.deepTeal,
                          ),
                          maxLines: 1,
                        ),
                      ],
                    ),
                  ),
                ),
              ),
          ],
        ),
      ),
    );
  }

  Widget _buildCheckoutHeader() {
    return Container(
      padding: EdgeInsets.all(ResponsiveUtils.getHorizontalPadding(context)),
      decoration: BoxDecoration(
        gradient: AppTheme.cardBackgroundGradient,
        borderRadius: BorderRadius.circular(16),
        boxShadow: AppTheme.complementaryElevation,
      ),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(8),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [AppTheme.deepTeal, AppTheme.cloud],
              ),
              borderRadius: BorderRadius.circular(12),
            ),
            child: Icon(
              Icons.shopping_cart_checkout,
              color: AppTheme.angel,
              size: ResponsiveUtils.getIconSize(context, baseSize: 24),
            ),
          ),
          SizedBox(width: ResponsiveUtils.getHorizontalPadding(context)),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                SafeUI.safeText(
                  'Secure Checkout',
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getTitleSize(context),
                    fontWeight: FontWeight.w600,
                    color: AppTheme.deepTeal,
                  ),
                  maxLines: 1,
                ),
                SafeUI.safeText(
                  'Complete your order securely',
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getTitleSize(context) - 4,
                    color: AppTheme.breeze,
                  ),
                  maxLines: 1,
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildStoreInfoSection() {
    return Container(
      padding: EdgeInsets.all(ResponsiveUtils.getHorizontalPadding(context)),
      decoration: BoxDecoration(
        gradient: AppTheme.cardBackgroundGradient,
        borderRadius: BorderRadius.circular(16),
        boxShadow: AppTheme.complementaryElevation,
        border: Border.all(
          color: AppTheme.breeze.withOpacity(0.2),
          width: 1,
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(
                Icons.storefront,
                color: AppTheme.deepTeal,
                size: ResponsiveUtils.getIconSize(context, baseSize: 20),
              ),
              SizedBox(width: ResponsiveUtils.getHorizontalPadding(context) * 0.5),
              SafeUI.safeText(
                'Store Information',
                style: TextStyle(
                  fontSize: ResponsiveUtils.getTitleSize(context),
                  fontWeight: FontWeight.w600,
                  color: AppTheme.deepTeal,
                ),
                maxLines: 1,
              ),
            ],
          ),
          SizedBox(height: ResponsiveUtils.getVerticalPadding(context)),
          SafeUI.safeText(
            'Store: ${_storeName ?? 'N/A'}',
            style: TextStyle(
              fontSize: ResponsiveUtils.getTitleSize(context) - 2,
              fontWeight: FontWeight.w600,
              color: AppTheme.deepTeal,
            ),
            maxLines: 1,
          ),
          SizedBox(height: ResponsiveUtils.getVerticalPadding(context) * 0.3),
          Row(
            children: [
              Container(
                width: 8,
                height: 8,
                decoration: BoxDecoration(
                  color: _isStoreCurrentlyOpen() ? Colors.green : Colors.red,
                  shape: BoxShape.circle,
                ),
              ),
              SizedBox(width: ResponsiveUtils.getHorizontalPadding(context) * 0.3),
              SafeUI.safeText(
                _isStoreCurrentlyOpen() ? 'Store is Open' : 'Store is Closed',
                style: TextStyle(
                  fontSize: ResponsiveUtils.getTitleSize(context) - 2,
                  fontWeight: FontWeight.w600,
                  color: _isStoreCurrentlyOpen() ? Colors.green : Colors.red,
                ),
                maxLines: 1,
              ),
            ],
          ),
          SizedBox(height: ResponsiveUtils.getVerticalPadding(context) * 0.3),
          SafeUI.safeText(
            'Operating Hours: ${_storeOpenHour ?? 'N/A'} - ${_storeCloseHour ?? 'N/A'}',
            style: TextStyle(
              fontSize: ResponsiveUtils.getTitleSize(context) - 2,
              color: AppTheme.breeze,
            ),
            maxLines: 1,
          ),
          // Debug: Print current values
          Builder(
            builder: (context) {
              print('üîç DEBUG: Store info display:');
              print('  - _storeOpenHour: $_storeOpenHour');
              print('  - _storeCloseHour: $_storeCloseHour');
              print('  - _storeOpenHour ?? N/A: ${_storeOpenHour ?? 'N/A'}');
              print('  - _storeCloseHour ?? N/A: ${_storeCloseHour ?? 'N/A'}');
              return const SizedBox.shrink();
            },
          ),
          SizedBox(height: ResponsiveUtils.getVerticalPadding(context) * 0.3),
          SafeUI.safeText(
            'Delivery Available: ${_isStoreCurrentlyOpen() ? 'Yes' : 'No'}',
            style: TextStyle(
              fontSize: ResponsiveUtils.getTitleSize(context) - 2,
              color: AppTheme.deepTeal,
            ),
            maxLines: 1,
          ),
        ],
      ),
    );
  }

  Widget _buildDeliverySection() {
    return Container(
      padding: EdgeInsets.all(ResponsiveUtils.getHorizontalPadding(context)),
      decoration: BoxDecoration(
        gradient: AppTheme.cardBackgroundGradient,
        borderRadius: BorderRadius.circular(16),
        boxShadow: AppTheme.complementaryElevation,
        border: Border.all(
          color: AppTheme.breeze.withOpacity(0.2),
          width: 1,
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(
                Icons.location_on,
                color: AppTheme.deepTeal,
                size: ResponsiveUtils.getIconSize(context, baseSize: 20),
              ),
              SizedBox(width: ResponsiveUtils.getHorizontalPadding(context) * 0.5),
              SafeUI.safeText(
                'Delivery Information',
                style: TextStyle(
                  fontSize: ResponsiveUtils.getTitleSize(context),
                  fontWeight: FontWeight.w600,
                  color: AppTheme.deepTeal,
                ),
                maxLines: 1,
              ),
            ],
          ),
          SizedBox(height: ResponsiveUtils.getVerticalPadding(context)),
          
          // Name Field
                TextFormField(
                  controller: _nameController,
            decoration: InputDecoration(
                    labelText: 'Full Name',
              labelStyle: TextStyle(color: AppTheme.breeze),
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: BorderSide(color: AppTheme.breeze.withOpacity(0.3)),
              ),
              enabledBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: BorderSide(color: AppTheme.breeze.withOpacity(0.3)),
              ),
              focusedBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: BorderSide(color: AppTheme.deepTeal, width: 2),
              ),
              prefixIcon: Icon(Icons.person, color: AppTheme.breeze),
                  ),
                  validator: (value) =>
                      (value == null || value.isEmpty) ? 'Please enter your name' : null,
                ),
          SizedBox(height: ResponsiveUtils.getVerticalPadding(context)),
          
          // Delivery/Pickup Toggle
          Container(
            padding: EdgeInsets.all(ResponsiveUtils.getHorizontalPadding(context)),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [AppTheme.deepTeal.withOpacity(0.1), AppTheme.cloud.withOpacity(0.05)],
              ),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(
                color: AppTheme.deepTeal.withOpacity(0.3),
              ),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  'Order Type',
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getTitleSize(context),
                    fontWeight: FontWeight.w600,
                    color: AppTheme.deepTeal,
                  ),
                ),
                SizedBox(height: ResponsiveUtils.getVerticalPadding(context) * 0.5),
                Row(
                  children: [
                    Expanded(
                      child: GestureDetector(
                        onTap: () {
                          setState(() {
                            _isDelivery = true;
                          });
                          // Recalculate delivery fee when switching to delivery
                          if (currentUser != null) {
                            _calculateDeliveryFeeAndCheckStore();
                          }
                        },
                        child: Container(
                          padding: EdgeInsets.all(ResponsiveUtils.getHorizontalPadding(context) * 0.8),
                          decoration: BoxDecoration(
                            color: _isDelivery ? AppTheme.deepTeal : AppTheme.whisper,
                            borderRadius: BorderRadius.circular(8),
                            border: Border.all(
                              color: _isDelivery ? AppTheme.deepTeal : AppTheme.breeze.withOpacity(0.3),
                            ),
                          ),
                          child: Row(
                            children: [
                              Icon(
                                Icons.delivery_dining,
                                color: _isDelivery ? AppTheme.angel : AppTheme.breeze,
                                size: 20,
                              ),
                              SizedBox(width: 8),
                              Text(
                                'Delivery',
                                style: TextStyle(
                                  fontSize: ResponsiveUtils.getTitleSize(context) - 2,
                                  fontWeight: FontWeight.w600,
                                  color: _isDelivery ? AppTheme.angel : AppTheme.breeze,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                    SizedBox(width: ResponsiveUtils.getHorizontalPadding(context) * 0.5),
                    Expanded(
                      child: GestureDetector(
                        onTap: () {
                          setState(() {
                            _isDelivery = false;
                          });
                          // Clear delivery fee when switching to pickup
                          setState(() {
                            _deliveryFee = 0.0;
                            _deliveryDistance = 0.0;
                          });
                        },
                        child: Container(
                          padding: EdgeInsets.all(ResponsiveUtils.getHorizontalPadding(context) * 0.8),
                          decoration: BoxDecoration(
                            color: !_isDelivery ? AppTheme.deepTeal : AppTheme.whisper,
                            borderRadius: BorderRadius.circular(8),
                            border: Border.all(
                              color: !_isDelivery ? AppTheme.deepTeal : AppTheme.breeze.withOpacity(0.3),
                            ),
                          ),
                          child: Row(
                            children: [
                              Icon(
                                Icons.store,
                                color: !_isDelivery ? AppTheme.angel : AppTheme.breeze,
                                size: 20,
                              ),
                              SizedBox(width: 8),
                              Text(
                                'Pick Up',
                                style: TextStyle(
                                  fontSize: ResponsiveUtils.getTitleSize(context) - 2,
                                  fontWeight: FontWeight.w600,
                                  color: !_isDelivery ? AppTheme.angel : AppTheme.breeze,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
          SizedBox(height: ResponsiveUtils.getVerticalPadding(context)),
          
          // Address Field with Inline Search
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              TextFormField(
                controller: _addressController,
                focusNode: _addressFocusNode,
                decoration: InputDecoration(
                  labelText: _isDelivery ? 'Delivery Address' : 'Pickup Address',
                  labelStyle: TextStyle(color: AppTheme.breeze),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: BorderSide(color: AppTheme.breeze.withOpacity(0.3)),
                  ),
                  enabledBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: BorderSide(color: AppTheme.breeze.withOpacity(0.3)),
                  ),
                  focusedBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: BorderSide(color: AppTheme.deepTeal, width: 2),
                  ),
                  prefixIcon: Icon(Icons.location_on, color: AppTheme.breeze),
                  suffixIcon: _isSearchingAddress
                      ? Padding(
                          padding: const EdgeInsets.all(12),
                          child: SizedBox(
                            width: 16,
                            height: 16,
                            child: CircularProgressIndicator(
                              strokeWidth: 2,
                              valueColor: AlwaysStoppedAnimation<Color>(AppTheme.deepTeal),
                            ),
                          ),
                        )
                      : _addressController.text.isNotEmpty
                          ? IconButton(
                              icon: Icon(Icons.clear, color: AppTheme.deepTeal),
                              onPressed: () {
                                _addressController.clear();
                                _validatedAddress = null;
                                setState(() {
                                  _addressSuggestions = [];
                                  _isSearchingAddress = false;
                                });
                              },
                            )
                          : Icon(Icons.search, color: AppTheme.deepTeal),
                ),
                onChanged: (value) {
                  setState(() {});
                  if (value.trim().isNotEmpty) {
                    _searchAddressesInline(value);
                  } else {
                    _addressSuggestions = [];
                  }
                },
                validator: (value) {
                  if (_isDelivery) {
                    if (value == null || value.isEmpty) return 'Please enter your address';
                  }
                  return null;
                },
              ),
              // Inline Address Suggestions
              if (_addressSuggestions.isNotEmpty)
                Container(
                  margin: const EdgeInsets.only(top: 8),
                  constraints: const BoxConstraints(maxHeight: 300),
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(color: AppTheme.breeze.withOpacity(0.3)),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withOpacity(0.1),
                        blurRadius: 8,
                        offset: const Offset(0, 2),
                      ),
                    ],
                  ),
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      // Header
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: AppTheme.deepTeal.withOpacity(0.1),
                          borderRadius: const BorderRadius.only(
                            topLeft: Radius.circular(12),
                            topRight: Radius.circular(12),
                          ),
                        ),
                        child: Row(
                          children: [
                            Icon(Icons.search, color: AppTheme.deepTeal, size: 16),
                            const SizedBox(width: 8),
                            Text(
                              'Address Suggestions',
                              style: TextStyle(
                                color: AppTheme.deepTeal,
                                fontWeight: FontWeight.w600,
                                fontSize: 12,
                              ),
                            ),
                          ],
                        ),
                      ),
                      // Suggestions List
                      Flexible(
                        child: ListView.builder(
                          shrinkWrap: true,
                          physics: const ClampingScrollPhysics(),
                          itemCount: _addressSuggestions.length + 1, // +1 for "Use entered address" option
                          itemBuilder: (context, index) {
                            if (index == _addressSuggestions.length) {
                              // "Use entered address" option
                              return ListTile(
                                leading: Icon(Icons.edit, color: AppTheme.primaryGreen),
                                title: Text(
                                  'Use entered address',
                                  style: TextStyle(
                                    color: AppTheme.primaryGreen,
                                    fontWeight: FontWeight.w600,
                                  ),
                                ),
                                subtitle: Text(
                                  _addressController.text,
                                  style: TextStyle(color: AppTheme.breeze),
                                ),
                                onTap: () {
                                  _validatedAddress = _addressController.text;
                                  setState(() {
                                    _addressSuggestions = [];
                                  });
                                  _calculateDeliveryFeeAndCheckStore();
                                },
                              );
                            }
                            
                            final placemark = _addressSuggestions[index];
                            final address = _formatAddress(placemark);
                            
                            return ListTile(
                              leading: Icon(Icons.location_on, color: AppTheme.deepTeal),
                              title: Text(
                                address,
                                style: TextStyle(
                                  fontWeight: FontWeight.w600,
                                  color: AppTheme.deepTeal,
                                ),
                              ),
                              subtitle: placemark.country != null
                                  ? Text(
                                      placemark.country!,
                                      style: TextStyle(
                                        color: AppTheme.breeze,
                                        fontSize: 12,
                                      ),
                                    )
                                  : null,
                              onTap: () {
                                _addressController.text = address;
                                _validatedAddress = address;
                                setState(() {
                                  _addressSuggestions = [];
                                });
                                _calculateDeliveryFeeAndCheckStore();
                              },
                            );
                          },
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
          SizedBox(height: ResponsiveUtils.getVerticalPadding(context)),
          
          // Phone Field
                TextFormField(
                  controller: _phoneController,
            decoration: InputDecoration(
                    labelText: 'Phone Number',
              labelStyle: TextStyle(color: AppTheme.breeze),
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: BorderSide(color: AppTheme.breeze.withOpacity(0.3)),
              ),
              enabledBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: BorderSide(color: AppTheme.breeze.withOpacity(0.3)),
              ),
              focusedBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: BorderSide(color: AppTheme.deepTeal, width: 2),
              ),
              prefixIcon: Icon(Icons.phone, color: AppTheme.breeze),
                  ),
                  keyboardType: TextInputType.phone,
                  validator: (value) {
                    if (value == null || value.isEmpty) return 'Please enter your phone number';
                    final phoneReg = RegExp(r'^(\+?\d{10,15})');
                    if (!phoneReg.hasMatch(value)) return 'Enter a valid phone number';
                    return null;
                  },
                ),
          SizedBox(height: ResponsiveUtils.getVerticalPadding(context)),
          
          // Delivery Instructions
                TextFormField(
                  controller: _deliveryInstructionsController,
            decoration: InputDecoration(
                    labelText: _isDelivery ? 'Delivery Instructions (optional)' : 'Pickup Instructions (optional)',
              labelStyle: TextStyle(color: AppTheme.breeze),
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: BorderSide(color: AppTheme.breeze.withOpacity(0.3)),
              ),
              enabledBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: BorderSide(color: AppTheme.breeze.withOpacity(0.3)),
              ),
              focusedBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12),
                borderSide: BorderSide(color: AppTheme.deepTeal, width: 2),
              ),
              prefixIcon: Icon(Icons.note, color: AppTheme.breeze),
                  ),
                  maxLines: 2,
                ),
          SizedBox(height: ResponsiveUtils.getVerticalPadding(context)),
          
          // Special Requests Section
          Container(
            padding: EdgeInsets.all(ResponsiveUtils.getHorizontalPadding(context)),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [AppTheme.deepTeal.withOpacity(0.1), AppTheme.cloud.withOpacity(0.05)],
              ),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(
                color: AppTheme.deepTeal.withOpacity(0.3),
                width: 1,
              ),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Icon(
                      Icons.add_circle_outline,
                      color: AppTheme.deepTeal,
                      size: ResponsiveUtils.getIconSize(context, baseSize: 18),
                    ),
                    SizedBox(width: ResponsiveUtils.getHorizontalPadding(context) * 0.3),
                    SafeUI.safeText(
                      'Special Requests',
                      style: TextStyle(
                        fontSize: ResponsiveUtils.getTitleSize(context) - 2,
                        fontWeight: FontWeight.w600,
                        color: AppTheme.deepTeal,
                      ),
                      maxLines: 1,
                    ),
                  ],
                ),
                SizedBox(height: ResponsiveUtils.getVerticalPadding(context) * 0.3),
                SafeUI.safeText(
                  'Add any special instructions, dietary preferences, or delivery preferences here',
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getTitleSize(context) - 4,
                    color: AppTheme.breeze,
                    height: 1.3,
                  ),
                  maxLines: 2,
                ),
                SizedBox(height: ResponsiveUtils.getVerticalPadding(context) * 0.5),
                TextFormField(
                  controller: _deliveryInstructionsController,
                  decoration: InputDecoration(
                    hintText: 'e.g., "No onions please", "Call when arriving", "Leave at gate"',
                    hintStyle: TextStyle(
                      color: AppTheme.breeze.withOpacity(0.7),
                      fontSize: ResponsiveUtils.getTitleSize(context) - 4,
                    ),
                    filled: true,
                    fillColor: AppTheme.angel,
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: BorderSide(color: AppTheme.breeze.withOpacity(0.3)),
                    ),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: BorderSide(color: AppTheme.breeze.withOpacity(0.3)),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: BorderSide(color: AppTheme.deepTeal, width: 2),
                    ),
                    contentPadding: EdgeInsets.symmetric(
                      horizontal: ResponsiveUtils.getHorizontalPadding(context) * 0.8,
                      vertical: ResponsiveUtils.getVerticalPadding(context) * 0.8,
                    ),
                  ),
                  maxLines: 3,
                ),
                SizedBox(height: ResponsiveUtils.getVerticalPadding(context) * 0.5),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildPaymentSection() {
    // Ensure we always have payment methods
    final availablePaymentMethods = _paymentMethods.isNotEmpty 
        ? _paymentMethods 
        : ['Cash on Delivery', 'PayFast', 'Card Payment'];
    
    print('üîç DEBUG: Building payment section with methods: $availablePaymentMethods');
    
    return Container(
      padding: EdgeInsets.all(ResponsiveUtils.getHorizontalPadding(context)),
      decoration: BoxDecoration(
        gradient: AppTheme.cardBackgroundGradient,
        borderRadius: BorderRadius.circular(16),
        boxShadow: AppTheme.complementaryElevation,
        border: Border.all(
          color: AppTheme.breeze.withOpacity(0.2),
          width: 1,
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(
                Icons.payment,
                color: AppTheme.deepTeal,
                size: ResponsiveUtils.getIconSize(context, baseSize: 20),
              ),
              SizedBox(width: ResponsiveUtils.getHorizontalPadding(context) * 0.5),
              SafeUI.safeText(
                'Payment Method',
                style: TextStyle(
                  fontSize: ResponsiveUtils.getTitleSize(context),
                  fontWeight: FontWeight.w600,
                  color: AppTheme.deepTeal,
                ),
                maxLines: 1,
              ),
            ],
          ),
          SizedBox(height: ResponsiveUtils.getVerticalPadding(context)),
          
          // Always show payment methods dropdown
            DropdownButtonFormField<String>(
                      value: _selectedPaymentMethod,
            items: availablePaymentMethods
                  .map((m) => DropdownMenuItem(
                      value: m,
                      child: SafeUI.safeText(
                        m,
                        style: TextStyle(
                          fontSize: ResponsiveUtils.getTitleSize(context) - 2,
                          color: AppTheme.deepTeal,
                        ),
                        maxLines: 1,
                      )))
                          .toList(),
                      onChanged: _isLoading ? null : (val) => setState(() => _selectedPaymentMethod = val),
              decoration: InputDecoration(
                        labelText: 'Select Payment Method',
                labelStyle: TextStyle(color: AppTheme.breeze),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide(color: AppTheme.breeze.withOpacity(0.3)),
                ),
                enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide(color: AppTheme.breeze.withOpacity(0.3)),
                ),
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide(color: AppTheme.deepTeal, width: 2),
                ),
                prefixIcon: Icon(Icons.credit_card, color: AppTheme.breeze),
                      ),
                      validator: (value) => value == null ? 'Please select a payment method' : null,
                    ),
        ],
      ),
    );
  }

  Widget _buildOrderSummary(double grandTotal) {
    return Container(
      padding: EdgeInsets.all(ResponsiveUtils.getHorizontalPadding(context)),
      decoration: BoxDecoration(
        gradient: AppTheme.cardBackgroundGradient,
        borderRadius: BorderRadius.circular(16),
        boxShadow: AppTheme.complementaryElevation,
        border: Border.all(
          color: AppTheme.breeze.withOpacity(0.2),
          width: 1,
        ),
      ),
      child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
          Row(
            children: [
              Icon(
                Icons.receipt_long,
                color: AppTheme.deepTeal,
                size: ResponsiveUtils.getIconSize(context, baseSize: 20),
              ),
              SizedBox(width: ResponsiveUtils.getHorizontalPadding(context) * 0.5),
              SafeUI.safeText(
                'Order Summary',
                style: TextStyle(
                  fontSize: ResponsiveUtils.getTitleSize(context),
                  fontWeight: FontWeight.w600,
                  color: AppTheme.deepTeal,
                ),
                maxLines: 1,
              ),
            ],
          ),
          SizedBox(height: ResponsiveUtils.getVerticalPadding(context)),
          
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              SafeUI.safeText(
                'Subtotal',
                style: TextStyle(
                  fontSize: ResponsiveUtils.getTitleSize(context),
                  color: AppTheme.breeze,
                ),
                maxLines: 1,
              ),
              SafeUI.safeText(
                'R${widget.totalPrice.toStringAsFixed(2)}',
                style: TextStyle(
                  fontSize: ResponsiveUtils.getTitleSize(context),
                  fontWeight: FontWeight.w600,
                  color: AppTheme.deepTeal,
                ),
                maxLines: 1,
                ),
              ],
            ),
          SizedBox(height: ResponsiveUtils.getVerticalPadding(context) * 0.5),
          
          if (_isDelivery) ...[
            // Debug logging for delivery fee display
            Builder(
              builder: (context) {
                final displayFee = _deliveryFee ?? 15.0;
                print('üîç DEBUG: Rendering delivery fee section');
                print('  - Is delivery: $_isDelivery');
                print('  - Delivery fee: $displayFee');
                print('  - Raw delivery fee: $_deliveryFee');
                return Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    SafeUI.safeText(
                      'Delivery Fee',
                      style: TextStyle(
                        fontSize: ResponsiveUtils.getTitleSize(context),
                        color: AppTheme.breeze,
                      ),
                      maxLines: 1,
                    ),
                    SafeUI.safeText(
                      'R${displayFee.toStringAsFixed(2)}',
                      style: TextStyle(
                        fontSize: ResponsiveUtils.getTitleSize(context),
                        fontWeight: FontWeight.w600,
                        color: AppTheme.deepTeal,
                      ),
                      maxLines: 1,
                    ),
                  ],
                );
              },
            ),
            SizedBox(height: ResponsiveUtils.getVerticalPadding(context) * 0.3),
            
            // Rural Delivery Widget
            if (_isRuralArea) ...[
              RuralDeliveryWidget(
                distance: _deliveryDistance,
                currentDeliveryFee: _deliveryFee ?? 0.0,
                onDeliveryOptionSelected: _onRuralDeliveryOptionSelected,
                isRuralArea: _isRuralArea,
              ),
              SizedBox(height: ResponsiveUtils.getVerticalPadding(context) * 0.3),
            ],
            
            // Urban Delivery Widget
            if (_isUrbanArea) ...[
              UrbanDeliveryWidget(
                distance: _deliveryDistance,
                currentDeliveryFee: _deliveryFee ?? 0.0,
                onDeliveryOptionSelected: _onUrbanDeliveryOptionSelected,
                isUrbanArea: _isUrbanArea,
                category: _productCategory,
                deliveryTime: DateTime.now(),
              ),
              SizedBox(height: ResponsiveUtils.getVerticalPadding(context) * 0.3),
            ],
          ] else ...[
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                SafeUI.safeText(
                  'Pickup',
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getTitleSize(context),
                    color: AppTheme.breeze,
                  ),
                  maxLines: 1,
                ),
                SafeUI.safeText(
                  'Free',
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getTitleSize(context),
                    fontWeight: FontWeight.w600,
                    color: AppTheme.primaryGreen,
                  ),
                  maxLines: 1,
                ),
              ],
            ),
          ],
          
          if (_isDelivery && _deliveryTimeMinutes != null) ...[
            SizedBox(height: ResponsiveUtils.getVerticalPadding(context) * 0.5),
            Container(
              padding: EdgeInsets.symmetric(
                horizontal: ResponsiveUtils.getHorizontalPadding(context) * 0.8,
                vertical: ResponsiveUtils.getVerticalPadding(context) * 0.5,
              ),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [AppTheme.cloud.withOpacity(0.2), AppTheme.breeze.withOpacity(0.1)],
                ),
                borderRadius: BorderRadius.circular(10),
                border: Border.all(
                  color: AppTheme.cloud.withOpacity(0.3),
                  width: 1,
                ),
              ),
              child: Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(4),
                    decoration: BoxDecoration(
                      color: AppTheme.cloud.withOpacity(0.2),
                      borderRadius: BorderRadius.circular(6),
                    ),
                    child: Icon(
                      Icons.schedule,
                      color: AppTheme.deepTeal,
                      size: ResponsiveUtils.getIconSize(context, baseSize: 16),
                    ),
                  ),
                  SizedBox(width: ResponsiveUtils.getHorizontalPadding(context) * 0.5),
                  Expanded(
                    child: SafeUI.safeText(
                      'Estimated ${_isDelivery ? 'Delivery' : 'Pickup'}: $_deliveryTimeMinutes min',
                      style: TextStyle(
                        fontSize: ResponsiveUtils.getTitleSize(context) - 2,
                        color: AppTheme.deepTeal,
                        fontWeight: FontWeight.w600,
                      ),
                      maxLines: 1,
                    ),
                  ),
                ],
              ),
            ),
          ],
          
          // Show delivery/pickup instructions if added
          if (_deliveryInstructionsController.text.isNotEmpty) ...[
            SizedBox(height: ResponsiveUtils.getVerticalPadding(context) * 0.5),
            Container(
              padding: EdgeInsets.symmetric(
                horizontal: ResponsiveUtils.getHorizontalPadding(context) * 0.8,
                vertical: ResponsiveUtils.getVerticalPadding(context) * 0.5,
              ),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [AppTheme.deepTeal.withOpacity(0.1), AppTheme.cloud.withOpacity(0.05)],
                ),
                borderRadius: BorderRadius.circular(10),
                border: Border.all(
                  color: AppTheme.deepTeal.withOpacity(0.3),
                  width: 1,
                ),
              ),
              child: Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(4),
                    decoration: BoxDecoration(
                      color: AppTheme.deepTeal.withOpacity(0.2),
                      borderRadius: BorderRadius.circular(6),
                    ),
                    child: Icon(
                      Icons.note,
                      color: AppTheme.deepTeal,
                      size: ResponsiveUtils.getIconSize(context, baseSize: 16),
                    ),
                  ),
                  SizedBox(width: ResponsiveUtils.getHorizontalPadding(context) * 0.5),
                  Expanded(
                    child: SafeUI.safeText(
                      'Special Request: ${_deliveryInstructionsController.text}',
                      style: TextStyle(
                        fontSize: ResponsiveUtils.getTitleSize(context) - 2,
                        color: AppTheme.deepTeal,
                        fontWeight: FontWeight.w500,
                      ),
                      maxLines: 2,
                    ),
                  ),
                ],
              ),
            ),
          ],
          
          Divider(
            height: ResponsiveUtils.getVerticalPadding(context) * 2,
            color: AppTheme.breeze.withOpacity(0.3),
            thickness: 1,
          ),
          
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              SafeUI.safeText(
                'Total',
                style: TextStyle(
                  fontSize: ResponsiveUtils.getTitleSize(context) + 4,
                  fontWeight: FontWeight.bold,
                  color: AppTheme.deepTeal,
                ),
                maxLines: 1,
              ),
              SafeUI.safeText(
                'R${grandTotal.toStringAsFixed(2)}',
                style: TextStyle(
                  fontSize: ResponsiveUtils.getTitleSize(context) + 6,
                  fontWeight: FontWeight.bold,
                  color: AppTheme.deepTeal,
                ),
                maxLines: 1,
              ),
            ],
            ),
        ],
      ),
    );
  }

  Widget _buildPlaceOrderButton() {
    return Container(
      width: double.infinity,
      decoration: BoxDecoration(
        gradient: AppTheme.primaryButtonGradient,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: AppTheme.deepTeal.withOpacity(0.3),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          borderRadius: BorderRadius.circular(12),
          onTap: _isLoading ? null : _submitOrder,
          child: Padding(
            padding: EdgeInsets.symmetric(
              vertical: ResponsiveUtils.getVerticalPadding(context) * 1.2,
              horizontal: ResponsiveUtils.getHorizontalPadding(context),
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(
                  Icons.shopping_bag_outlined,
                  color: AppTheme.angel,
                  size: ResponsiveUtils.getIconSize(context, baseSize: 24),
                ),
                SizedBox(width: ResponsiveUtils.getHorizontalPadding(context) * 0.5),
                SafeUI.safeText(
                  _selectedPaymentMethod?.toLowerCase().contains('cash') == true 
                      ? 'Place Order' 
                      : 'Continue to Payment',
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getTitleSize(context) + 2,
                    fontWeight: FontWeight.w600,
                    color: AppTheme.angel,
                  ),
                  maxLines: 1,
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }






}

// Enhanced AddressSearchScreen with suggestions
class AddressSearchScreen extends StatefulWidget {
  @override
  _AddressSearchScreenState createState() => _AddressSearchScreenState();
}

class _AddressSearchScreenState extends State<AddressSearchScreen> {
  final TextEditingController _searchController = TextEditingController();
  List<Placemark> _suggestions = [];
  bool _isLoading = false;
  Timer? _debounceTimer;

  @override
  void initState() {
    super.initState();
    _searchController.addListener(_onSearchChanged);
  }

  @override
  void dispose() {
    _searchController.dispose();
    _debounceTimer?.cancel();
    super.dispose();
  }

  void _onSearchChanged() {
    // Debounce the search to avoid too many API calls
    _debounceTimer?.cancel();
    _debounceTimer = Timer(const Duration(milliseconds: 500), () {
      _searchAddresses();
    });
  }

  Future<void> _searchAddresses() async {
    final query = _searchController.text.trim();
    if (query.length < 3) {
      setState(() {
        _suggestions = [];
        _isLoading = false;
      });
      return;
    }

    setState(() {
      _isLoading = true;
    });

    try {
      // Search for addresses using geocoding
      final locations = await locationFromAddress(query);
      
      if (locations.isNotEmpty) {
        // Get detailed address information for each location
        List<Placemark> placemarks = [];
        for (final location in locations.take(5)) { // Limit to 5 results
          try {
            final placemarkList = await placemarkFromCoordinates(
              location.latitude,
              location.longitude,
            );
            if (placemarkList.isNotEmpty) {
              placemarks.addAll(placemarkList);
            }
          } catch (e) {
            print('Error getting placemark for location: $e');
          }
        }
        
        setState(() {
          _suggestions = placemarks;
          _isLoading = false;
        });
      } else {
        setState(() {
          _suggestions = [];
          _isLoading = false;
        });
      }
    } catch (e) {
      print('Error searching addresses: $e');
      setState(() {
        _suggestions = [];
        _isLoading = false;
      });
    }
  }

  String _formatAddress(Placemark placemark) {
    List<String> parts = [];
    
    if (placemark.street != null && placemark.street!.isNotEmpty) {
      parts.add(placemark.street!);
    }
    if (placemark.subLocality != null && placemark.subLocality!.isNotEmpty) {
      parts.add(placemark.subLocality!);
    }
    if (placemark.locality != null && placemark.locality!.isNotEmpty) {
      parts.add(placemark.locality!);
    }
    if (placemark.administrativeArea != null && placemark.administrativeArea!.isNotEmpty) {
      parts.add(placemark.administrativeArea!);
    }
    if (placemark.postalCode != null && placemark.postalCode!.isNotEmpty) {
      parts.add(placemark.postalCode!);
    }
    
    return parts.join(', ');
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Search Address'),
        backgroundColor: AppTheme.deepTeal,
        foregroundColor: AppTheme.angel,
        elevation: 0,
      ),
      body: Column(
        children: [
          // Search input
          Container(
            padding: const EdgeInsets.all(16.0),
            decoration: BoxDecoration(
              color: AppTheme.deepTeal,
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.1),
                  blurRadius: 4,
                  offset: const Offset(0, 2),
                ),
              ],
            ),
            child: TextField(
              controller: _searchController,
              decoration: InputDecoration(
                labelText: 'Enter your address',
                labelStyle: TextStyle(color: AppTheme.angel.withOpacity(0.8)),
                hintText: 'e.g., 123 Main Street, Johannesburg',
                hintStyle: TextStyle(color: AppTheme.angel.withOpacity(0.6)),
                filled: true,
                fillColor: AppTheme.angel,
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(12),
                  borderSide: BorderSide.none,
                ),
                prefixIcon: Icon(Icons.search, color: AppTheme.deepTeal),
                suffixIcon: _isLoading
                    ? Padding(
                        padding: const EdgeInsets.all(12.0),
                        child: SizedBox(
                          width: 20,
                          height: 20,
                          child: CircularProgressIndicator(
                            strokeWidth: 2,
                            valueColor: AlwaysStoppedAnimation<Color>(AppTheme.deepTeal),
                          ),
                        ),
                      )
                    : null,
              ),
              style: TextStyle(color: AppTheme.deepTeal),
            ),
          ),
          
          // Suggestions list
          Expanded(
            child: _suggestions.isEmpty && !_isLoading
                ? _buildEmptyState()
                : ListView.builder(
                    padding: const EdgeInsets.all(16.0),
                    itemCount: _suggestions.length,
                    itemBuilder: (context, index) {
                      final placemark = _suggestions[index];
                      final address = _formatAddress(placemark);
                      
                      return Card(
                        margin: const EdgeInsets.only(bottom: 8.0),
                        elevation: 2,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                        child: ListTile(
                          leading: Icon(
                            Icons.location_on,
                            color: AppTheme.deepTeal,
                          ),
                          title: Text(
                            address,
                            style: TextStyle(
                              fontWeight: FontWeight.w600,
                              color: AppTheme.deepTeal,
                            ),
                          ),
                          subtitle: placemark.country != null
                              ? Text(
                                  placemark.country!,
                                  style: TextStyle(
                                    color: AppTheme.breeze,
                                    fontSize: 12,
                                  ),
                                )
                              : null,
                          onTap: () {
                            Navigator.pop(context, address);
                          },
                        ),
                      );
                    },
                  ),
          ),
          
          // Manual address entry option
          if (_suggestions.isNotEmpty)
            Container(
              padding: const EdgeInsets.all(16.0),
              child: Column(
                children: [
                  const Divider(),
                  const SizedBox(height: 8),
                  Text(
                    'Or use your own address:',
                    style: TextStyle(
                      color: AppTheme.breeze,
                      fontSize: 14,
                    ),
                  ),
                  const SizedBox(height: 8),
                  SizedBox(
                    width: double.infinity,
                    child: ElevatedButton(
                      onPressed: () {
                        final address = _searchController.text.trim();
                        if (address.isNotEmpty) {
                          Navigator.pop(context, address);
                        } else {
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(
                              content: Text('Please enter an address.'),
                              backgroundColor: Colors.red,
                            ),
                          );
                        }
                      },
                      style: ElevatedButton.styleFrom(
                        backgroundColor: AppTheme.primaryGreen,
                        foregroundColor: AppTheme.angel,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                        padding: const EdgeInsets.symmetric(vertical: 16),
                      ),
                      child: const Text(
                        'Use Entered Address',
                        style: TextStyle(
                          fontWeight: FontWeight.w600,
                          fontSize: 16,
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
        ],
      ),
    );
  }

  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.location_on_outlined,
            size: 64,
            color: AppTheme.breeze.withOpacity(0.5),
          ),
          const SizedBox(height: 16),
          Text(
            'Search for your address',
            style: TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.w600,
              color: AppTheme.deepTeal,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            'Start typing to see address suggestions',
            style: TextStyle(
              fontSize: 14,
              color: AppTheme.breeze,
            ),
            textAlign: TextAlign.center,
          ),
        ],
      ),
    );
  }
}

